DÆ°á»›i Ä‘Ã¢y lÃ  **VBA code hoÃ n chá»‰nh** Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t Ä‘á»ƒ:

- Gá»i API SharePoint Online Ä‘á»ƒ láº¥y danh sÃ¡ch file theo chiá»u sÃ¢u (depth-first).
- Tá»± parse JSON mÃ  **khÃ´ng dÃ¹ng JsonConverter**.
- Ghi tÃªn file vÃ  path vÃ o Excel (báº¯t Ä‘áº§u tá»« hÃ ng 5, cá»™t A vÃ  B).
- Hoáº¡t Ä‘á»™ng á»•n Ä‘á»‹nh vá»›i UiPath thÃ´ng qua `Invoke VBA`.

---

### ğŸ”§ **VBA CODE - Save thÃ nh file `.bas` (vÃ­ dá»¥: `GetAllSharePointFiles.bas`)**

```vba
Option Explicit

' ===== HÃ m chÃ­nh Ä‘Æ°á»£c gá»i tá»« UiPath =====
Public Sub GetAllSharePointFiles()
    Dim ws As Worksheet
    Set ws = ThisWorkbook.Sheets(1)
    ws.Cells.ClearContents
    ws.Cells(2, 1).Value = "ãƒ•ã‚¡ã‚¤ãƒ«å"  ' TiÃªu Ä‘á» tiáº¿ng Nháº­t (TÃªn file)
    ws.Cells(2, 2).Value = "ãƒ‘ã‚¹"       ' TiÃªu Ä‘á» tiáº¿ng Nháº­t (ÄÆ°á»ng dáº«n)
    
    Dim token As String
    token = "Bearer [ACCESS_TOKEN]" ' <-- Nhá»› thay báº±ng access token tháº­t náº¿u gá»i ngoÃ i UiPath

    Dim siteUrl As String
    siteUrl = "https://contoso.sharepoint.com/sites/TestSite"

    Dim rootFolder As String
    rootFolder = "/Shared Documents"

    Dim rowIndex As Long
    rowIndex = 5

    Call ProcessFolder(siteUrl, rootFolder, token, ws, rowIndex)
End Sub

' ===== Äá»‡ quy duyá»‡t folder theo chiá»u sÃ¢u =====
Private Sub ProcessFolder(siteUrl As String, folderPath As String, token As String, ws As Worksheet, ByRef rowIndex As Long)
    Dim http As Object
    Set http = CreateObject("MSXML2.XMLHTTP")

    Dim url As String
    url = siteUrl & "/_api/web/GetFolderByServerRelativeUrl('" & folderPath & "')?$expand=Files,Folders"

    With http
        .Open "GET", url, False
        .setRequestHeader "Authorization", token
        .setRequestHeader "Accept", "application/json;odata=verbose"
        .Send
    End With

    If http.Status <> 200 Then Exit Sub

    Dim json As String
    json = http.responseText

    Dim filesJson As String
    filesJson = GetBetween(json, """Files"":{""results"":[", "]},") & "]"

    Dim foldersJson As String
    foldersJson = GetBetween(json, """Folders"":{""results"":[", "]},") & "]"

    ' Parse vÃ  ghi tá»«ng file
    Dim fileEntries() As String
    fileEntries = Split(filesJson, "},{")
    Dim f As Variant
    For Each f In fileEntries
        Dim nameVal As String
        nameVal = GetBetween(f, """Name"":""", """")

        Dim pathVal As String
        pathVal = GetBetween(f, """ServerRelativeUrl"":""", """")

        If nameVal <> "" And pathVal <> "" Then
            ws.Cells(rowIndex, 1).Value = nameVal
            ws.Cells(rowIndex, 2).Value = pathVal
            rowIndex = rowIndex + 1
        End If
    Next

    ' Äá»‡ quy vá»›i tá»«ng folder con
    Dim folderEntries() As String
    folderEntries = Split(foldersJson, "},{")
    Dim fd As Variant
    For Each fd In folderEntries
        Dim folderName As String
        folderName = GetBetween(fd, """Name"":""", """")

        If folderName <> "" And folderName <> "Forms" Then
            Call ProcessFolder(siteUrl, folderPath & "/" & folderName, token, ws, rowIndex)
        End If
    Next
End Sub

' ===== HÃ m cáº¯t chuá»—i Ä‘Æ¡n giáº£n thay cho JSON Parser =====
Private Function GetBetween(text As String, startStr As String, endStr As String) As String
    On Error GoTo Fail
    Dim startPos As Long, endPos As Long
    startPos = InStr(text, startStr)
    If startPos = 0 Then GoTo Fail
    startPos = startPos + Len(startStr)
    endPos = InStr(startPos, text, endStr)
    If endPos = 0 Then GoTo Fail
    GetBetween = Mid(text, startPos, endPos - startPos)
    Exit Function
Fail:
    GetBetween = ""
End Function
```

---

### ğŸªœ **Step-by-Step hÆ°á»›ng dáº«n dÃ¹ng vá»›i UiPath**

1. **Táº¡o file `.bas`**  
   - Má»Ÿ Notepad, dÃ¡n Ä‘oáº¡n code trÃªn.
   - LÆ°u vá»›i tÃªn: `GetAllSharePointFiles.bas`

2. **Import vÃ o Excel (thá»­ thá»§ cÃ´ng náº¿u cáº§n)**
   - ALT + F11 â†’ File â†’ Import File â†’ chá»n `GetAllSharePointFiles.bas`

3. **Trong UiPath: DÃ¹ng â€œInvoke VBAâ€**
   - `WorkbookPath`: ÄÆ°á»ng dáº«n tá»›i file Excel.
   - `MacroName`: `"GetAllSharePointFiles"`
   - `EntryMethodParameters`: `null` hoáº·c `New Object() {}`

4. **Äáº£m báº£o cÃ¡c Ä‘iá»u kiá»‡n sau**
   - File Excel **khÃ´ng chá»©a macro (.xlsx)** â†’ cáº§n Ä‘á»•i sang `.xlsm` náº¿u muá»‘n lÆ°u macro (náº¿u test).
   - Náº¿u dÃ¹ng `.xlsx`, thÃ¬ chá»‰ cáº§n `.bas` náº±m ngoÃ i vÃ  khÃ´ng cáº§n lÆ°u kÃ¨m macro.

---

### âœ… Æ¯u Ä‘iá»ƒm giáº£i phÃ¡p

- KhÃ´ng cáº§n JsonConverter
- Äá»‡ quy theo chiá»u sÃ¢u (depth-first)
- Ghi tháº³ng vÃ o Excel
- TÆ°Æ¡ng thÃ­ch UiPath

---

Náº¿u báº¡n muá»‘n mÃ¬nh xuáº¥t luÃ´n file `.bas` Ä‘á»ƒ Ä‘Ã­nh kÃ¨m hoáº·c viáº¿t thÃªm log/debug trong Excel, mÃ¬nh há»— trá»£ ngay nhÃ©.
