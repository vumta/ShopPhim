Ch√†o b·∫°n, ƒë√¢y l√† gi·∫£i ph√°p ho√†n ch·ªânh.
T√¥i ƒë√£ c·∫≠p nh·∫≠t l·∫°i to√†n b·ªô Code VBA ƒë·ªÉ s·ª≠ d·ª•ng k√Ω t·ª± ph√¢n c√°ch an to√†n (| v√† #) nh·∫±m tr√°nh l·ªói khi ch·∫°y t·ª´ Power Automate Desktop (PAD). Code c≈©ng ƒë√£ ƒë∆∞·ª£c khai b√°o bi·∫øn ƒë·∫ßy ƒë·ªß ƒë·ªÉ kh·∫Øc ph·ª•c l·ªói "Variable not defined".
1. üìÑ CODE VBA HO√ÄN CH·ªàNH (Copy & Paste v√†o Module Excel)
B·∫°n h√£y t·∫°o m·ªôt file Excel (v√≠ d·ª• MacroMaster.xlsm) ho·∫∑c l∆∞u v√†o file ƒë√≠ch c·ªßa b·∫°n, nh·∫•n Alt + F11, Insert > Module v√† d√°n to√†n b·ªô code sau:
Option Explicit

' ==========================================================================================
' C·∫§U H√åNH ƒê·ªäNH D·∫†NG CHU·ªñI MAPPING CHO PAD
' ==========================================================================================
' Do PAD g·∫∑p l·ªói v·ªõi d·∫•u ph·∫©y (,) v√† ch·∫•m ph·∫©y (;), ch√∫ng ta d√πng:
' - D·∫•u ThƒÉng (#) ƒë·ªÉ ph√¢n c√°ch c√°c c·∫∑p d·ªØ li·ªáu.
' - D·∫•u G·∫°ch ƒê·ª©ng (|) ƒë·ªÉ ph√¢n c√°ch gi√° tr·ªã trong m·ªôt c·∫∑p.
'
' V√≠ d·ª• Mapping Copy:    "T√™n C·ªôt|1#Gi√° Ti·ªÅn|3"
' V√≠ d·ª• Mapping Default: "5|ƒê√£ X·ª≠ L√Ω#6|2024"
' ==========================================================================================

' ------------------------------------------------------------------------------------------
' FUNCTION 1: COPY DATA (D·ª±a tr√™n t√™n c·ªôt ngu·ªìn -> Index c·ªôt ƒë√≠ch)
' ------------------------------------------------------------------------------------------
Public Function CopyDataByColumnName(ByVal SourcePath As String, _
                                     ByVal DestinationPath As String, _
                                     ByVal ColumnMapping As String) As String

    Dim wbSource As Workbook
    Dim wbDest As Workbook
    Dim wsSource As Worksheet
    Dim wsDest As Worksheet
    Dim arrMapping As Variant
    Dim arrPair As Variant
    Dim sSourceName As String
    Dim lDestIndex As Long
    Dim lSourceCol As Long
    Dim lLastRow As Long
    Dim lHeaderRow As Long
    Dim i As Long
    Dim lCol As Long ' Bi·∫øn ƒë·∫øm c·ªôt (ƒë√£ khai b√°o ƒë·∫ßy ƒë·ªß)
    Dim sErrorLog As String

    ' Kh·ªüi t·∫°o gi√° tr·ªã tr·∫£ v·ªÅ
    CopyDataByColumnName = "Success"

    On Error GoTo ErrorHandler

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    ' M·ªü file
    Set wbSource = Workbooks.Open(SourcePath)
    Set wbDest = Workbooks.Open(DestinationPath)

    ' Gi·∫£ ƒë·ªãnh Sheet 1 (S·ª≠a n·∫øu c·∫ßn)
    Set wsSource = wbSource.Sheets(1)
    Set wsDest = wbDest.Sheets(1)
    lHeaderRow = 1

    ' --- X·ª≠ l√Ω Mapping (D√πng d·∫•u #) ---
    arrMapping = Split(ColumnMapping, "#")

    ' --- B·∫Øt ƒë·∫ßu Copy ---
    For i = LBound(arrMapping) To UBound(arrMapping)
        If Trim(arrMapping(i)) <> "" Then
            ' T√°ch c·∫∑p b·∫±ng d·∫•u |
            arrPair = Split(arrMapping(i), "|")
            
            If UBound(arrPair) = 1 Then
                sSourceName = Trim(arrPair(0))
                
                On Error Resume Next
                lDestIndex = CLng(Trim(arrPair(1)))
                On Error GoTo ErrorHandler

                ' T√¨m c·ªôt ngu·ªìn theo t√™n
                lSourceCol = 0
                For lCol = 1 To wsSource.Cells(lHeaderRow, Columns.Count).End(xlToLeft).Column
                    If StrComp(Trim(wsSource.Cells(lHeaderRow, lCol).Value), sSourceName, vbTextCompare) = 0 Then
                        lSourceCol = lCol
                        Exit For
                    End If
                Next lCol

                ' Th·ª±c hi·ªán Copy
                If lSourceCol > 0 And lDestIndex > 0 Then
                    lLastRow = wsSource.Cells(Rows.Count, lSourceCol).End(xlUp).Row
                    
                    If lLastRow > lHeaderRow Then
                        ' Copy Value (B·ªè qua Header)
                        wsDest.Range(wsDest.Cells(lHeaderRow + 1, lDestIndex), wsDest.Cells(lLastRow, lDestIndex)).Value = _
                        wsSource.Range(wsSource.Cells(lHeaderRow + 1, lSourceCol), wsSource.Cells(lLastRow, lSourceCol)).Value
                    Else
                        sErrorLog = sErrorLog & "Warn: C·ªôt '" & sSourceName & "' r·ªóng. "
                    End If
                ElseIf lSourceCol = 0 Then
                    sErrorLog = sErrorLog & "Err: Kh√¥ng t√¨m th·∫•y c·ªôt ngu·ªìn '" & sSourceName & "'. "
                    CopyDataByColumnName = "Error: Missing Column"
                End If
            End If
        End If
    Next

    If Len(sErrorLog) > 0 And CopyDataByColumnName = "Success" Then
        CopyDataByColumnName = "Success with Warnings: " & sErrorLog
    End If

    ' L∆∞u v√† ƒê√≥ng
    wbDest.Save
    wbSource.Close SaveChanges:=False
    wbDest.Close SaveChanges:=False

    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    Exit Function

ErrorHandler:
    sErrorLog = "VBA Error: " & Err.Description
    CopyDataByColumnName = "Fatal Error: " & sErrorLog
    
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    On Error Resume Next
    If Not wbSource Is Nothing Then wbSource.Close SaveChanges:=False
    If Not wbDest Is Nothing Then wbDest.Close SaveChanges:=False
End Function

' ------------------------------------------------------------------------------------------
' FUNCTION 2: FILL DEFAULT VALUE (ƒêi·ªÅn gi√° tr·ªã m·∫∑c ƒë·ªãnh v√†o c·ªôt ƒë√≠ch)
' ------------------------------------------------------------------------------------------
Public Function FillDefaultValue(ByVal DestinationPath As String, _
                                 ByVal DefaultMapping As String) As String

    Dim wbDest As Workbook
    Dim wsDest As Worksheet
    Dim arrMapping As Variant
    Dim arrPair As Variant
    Dim lDestIndex As Long
    Dim vDefaultValue As Variant
    Dim lLastRow As Long
    Dim lHeaderRow As Long
    Dim i As Long

    FillDefaultValue = "Success"
    On Error GoTo ErrorHandler

    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    Set wbDest = Workbooks.Open(DestinationPath)
    Set wsDest = wbDest.Sheets(1)
    lHeaderRow = 1

    ' T√¨m d√≤ng cu·ªëi c√πng c√≥ d·ªØ li·ªáu c·ªßa to√†n b·ªô sheet (ƒë·ªÉ bi·∫øt c·∫ßn fill ƒë·∫øn ƒë√¢u)
    On Error Resume Next
    lLastRow = wsDest.Cells.Find(What:="*", After:=wsDest.Range("A1"), _
               LookIn:=xlValues, LookAt:=xlPart, SearchOrder:=xlByRows, _
               SearchDirection:=xlPrevious).Row
    On Error GoTo ErrorHandler

    If lLastRow <= lHeaderRow Then
        FillDefaultValue = "Success (No Data)"
        GoTo Finalize
    End If

    ' --- X·ª≠ l√Ω Mapping (D√πng d·∫•u #) ---
    arrMapping = Split(DefaultMapping, "#")

    ' --- B·∫Øt ƒë·∫ßu Fill ---
    For i = LBound(arrMapping) To UBound(arrMapping)
        If Trim(arrMapping(i)) <> "" Then
            ' T√°ch c·∫∑p b·∫±ng d·∫•u |
            arrPair = Split(arrMapping(i), "|")
            
            If UBound(arrPair) = 1 Then
                ' L·∫•y Index c·ªôt
                On Error Resume Next
                lDestIndex = CLng(Trim(arrPair(0)))
                On Error GoTo ErrorHandler
                
                ' L·∫•y gi√° tr·ªã m·∫∑c ƒë·ªãnh
                vDefaultValue = Trim(arrPair(1))
                
                If lDestIndex > 0 Then
                    ' ƒêi·ªÅn d·ªØ li·ªáu t·ª´ d√≤ng 2 ƒë·∫øn d√≤ng cu·ªëi c√πng
                    wsDest.Range(wsDest.Cells(lHeaderRow + 1, lDestIndex), wsDest.Cells(lLastRow, lDestIndex)).Value = vDefaultValue
                End If
            End If
        End If
    Next

    wbDest.Save

Finalize:
    wbDest.Close SaveChanges:=False
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    Exit Function

ErrorHandler:
    Dim sErrorLog As String
    sErrorLog = "VBA Error: " & Err.Description
    FillDefaultValue = "Fatal Error: " & sErrorLog
    
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    On Error Resume Next
    If Not wbDest Is Nothing Then wbDest.Close SaveChanges:=False
End Function

2. ü§ñ H∆Ø·ªöNG D·∫™N CHI TI·∫æT TRONG POWER AUTOMATE DESKTOP (PAD)
D∆∞·ªõi ƒë√¢y l√† t·ª´ng b∆∞·ªõc ƒë·ªÉ c·∫•u h√¨nh Flow trong PAD sao cho kh√¥ng b·ªã l·ªói tham s·ªë.
B∆∞·ªõc 1: Khai b√°o bi·∫øn (Set Variables)
T·∫°o c√°c bi·∫øn ƒë·ªÉ ch·ª©a ƒë∆∞·ªùng d·∫´n file v√† chu·ªói mapping. L∆∞u √Ω k·ªπ ƒë·ªãnh d·∫°ng chu·ªói m·ªõi.
 * Action: Set variable
   * Variable: %SourcePath%
   * Value: C:\Users\YourName\Documents\Source.xlsx
 * Action: Set variable
   * Variable: %DestPath%
   * Value: C:\Users\YourName\Documents\Destination.xlsx
 * Action: Set variable (Bi·∫øn Mapping cho Copy)
   * Variable: %CopyMapping%
   * Value: Product Name|1#Price|3#Quantity|5
   * (Nghƒ©a l√†: Copy c·ªôt "Product Name" v√†o c·ªôt 1, "Price" v√†o c·ªôt 3, "Quantity" v√†o c·ªôt 5)
 * Action: Set variable (Bi·∫øn Mapping cho Default Value)
   * Variable: %DefaultMapping%
   * Value: 8|Pending#9|2024
   * (Nghƒ©a l√†: ƒêi·ªÅn "Pending" v√†o c·ªôt 8, "2024" v√†o c·ªôt 9 cho t·∫•t c·∫£ c√°c d√≤ng)
B∆∞·ªõc 2: M·ªü file ch·ª©a Code Macro (Launcher)
ƒê·ªÉ ch·∫°y Macro, PAD c·∫ßn m·ªü file Excel ch·ª©a module code tr√™n.
 * Action: Launch Excel
   * Launch mode: Open the following document
   * Document path: ƒê∆∞·ªùng d·∫´n ƒë·∫øn file .xlsm ch·ª©a code VBA b·∫°n v·ª´a l∆∞u.
   * Variables produced: %ExcelInstance%
B∆∞·ªõc 3: Ch·∫°y Function 1 - Copy Data
 * Action: Run Excel macro
   * Excel instance: %ExcelInstance%
   * Macro name: CopyDataByColumnName
   * Macro arguments: %SourcePath%; %DestPath%; %CopyMapping%
     * L∆∞u √Ω: PAD d√πng d·∫•u ch·∫•m ph·∫©y v√† kho·∫£ng tr·∫Øng (; ) ƒë·ªÉ ngƒÉn c√°ch c√°c bi·∫øn khi nh·∫≠p v√†o √¥ input, nh∆∞ng b√™n trong bi·∫øn %CopyMapping% ch√∫ng ta ƒë√£ d√πng # n√™n s·∫Ω an to√†n.
     * C√°ch nh·∫≠p ƒë√∫ng: B·∫°n ch·ªâ c·∫ßn ch·ªçn bi·∫øn t·ª´ danh s√°ch bi·∫øn c·ªßa PAD, kh√¥ng t·ª± g√µ d·∫•u nh√°y k√©p "".
   * Variables produced: %ResultCopy%
B∆∞·ªõc 4: Ki·ªÉm tra k·∫øt qu·∫£ Copy v√† Ch·∫°y Function 2 - Fill Default
 * Action: If
   * First operand: %ResultCopy%
   * Operator: Contains
   * Second operand: Success
 *  **Action:** `Run Excel macro` (Ch·∫°y ti·∫øp function th·ª© 2)
 * **Excel instance:** `%ExcelInstance%`
 * **Macro name:** `FillDefaultValue`
 * **Macro arguments:** `%DestPath%; %DefaultMapping%`
 * **Variables produced:** `%ResultFill%`

 * Action: Else
   * Action: Display message (Th√¥ng b√°o l·ªói n·∫øu Copy th·∫•t b·∫°i)
   * Message to display: L·ªói Copy: %ResultCopy%
 * Action: End
B∆∞·ªõc 5: ƒê√≥ng Excel Launcher
 * Action: Close Excel
   * Excel instance: %ExcelInstance%
   * Before closing: Do not save document (File ch·ª©a macro kh√¥ng thay ƒë·ªïi g√¨ n√™n kh√¥ng c·∫ßn l∆∞u).
üí° L∆∞u √Ω quan tr·ªçng:
 * Trong m·ª•c Macro arguments c·ªßa PAD, b·∫°n TUY·ªÜT ƒê·ªêI KH√îNG bao quanh t√™n bi·∫øn b·∫±ng d·∫•u nh√°y k√©p.
   * Sai: "%SourcePath%"
   * ƒê√∫ng: %SourcePath%
 * H√£y ƒë·∫£m b·∫£o file Excel ƒë√≠ch (%DestPath%) ƒëang ƒê√ìNG tr∆∞·ªõc khi ch·∫°y Flow, v√¨ VBA s·∫Ω c·ªë g·∫Øng m·ªü n√≥. N·∫øu n√≥ ƒëang m·ªü s·∫µn, c√≥ th·ªÉ g√¢y l·ªói Permission denied ho·∫∑c Read-only.
