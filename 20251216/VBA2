Ch√†o b·∫°n,
T√¥i ƒë√£ chuy·ªÉn to√†n b·ªô comment trong code VBA sang ti·∫øng Anh v√† th√™m m·ªôt c∆° ch·∫ø ƒë·ªÉ macro c√≥ th·ªÉ tr·∫£ v·ªÅ m·ªôt gi√° tr·ªã/tr·∫°ng th√°i (v√≠ d·ª•: Success ho·∫∑c Error) ƒë·ªÉ Power Automate Desktop (PAD) c√≥ th·ªÉ l·∫•y ƒë∆∞·ª£c k·∫øt qu·∫£ th·ª±c thi.
üíª Updated VBA Code with English Comments and Return Value
Trong VBA, ƒë·ªÉ tr·∫£ v·ªÅ gi√° tr·ªã cho ·ª©ng d·ª•ng g·ªçi (nh∆∞ PAD), ta s·∫Ω c·∫ßn thay ƒë·ªïi Sub th√†nh Function.
Option Explicit

' Function to copy data from specified columns in a source Excel file
' to specified column indices in a destination Excel file.
' This function is designed to be executed via Power Automate Desktop (PAD)
' and returns a string indicating the execution status.

Public Function CopyDataByColumnName(ByVal SourcePath As String, _
                                     ByVal DestinationPath As String, _
                                     ByVal ColumnMapping As String) As String

    Dim wbSource As Workbook
    Dim wbDest As Workbook
    Dim wsSource As Worksheet
    Dim wsDest As Worksheet
    Dim arrMapping As Variant
    Dim arrPair As Variant
    Dim sSourceName As String
    Dim lDestIndex As Long
    Dim lSourceCol As Long
    Dim lLastRow As Long
    Dim lHeaderRow As Long
    Dim i As Long
    Dim sErrorLog As String ' To capture error messages or missed columns

    ' Initialize return value to Success
    CopyDataByColumnName = "Success"

    On Error GoTo ErrorHandler

    ' --- 1. Open Workbooks and Setup ---
    ' Disable screen updating and alerts for performance optimization
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False

    Set wbSource = Workbooks.Open(SourcePath)
    Set wbDest = Workbooks.Open(DestinationPath)

    ' Assume data is on Sheet 1 (Modify if needed)
    Set wsSource = wbSource.Sheets(1)
    Set wsDest = wbDest.Sheets(1)
    
    ' Assume the Header row is the first row (Modify if needed)
    lHeaderRow = 1 

    ' --- 2. Process Column Mapping ---
    ' Split the mapping string by semicolon (;)
    arrMapping = Split(ColumnMapping, ";")

    ' --- 3. Start Copy/Paste Process ---
    For i = LBound(arrMapping) To UBound(arrMapping)
        If Trim(arrMapping(i)) <> "" Then
            ' Split each pair by comma (,)
            arrPair = Split(arrMapping(i), ",")
            
            ' Ensure we have both source column name and destination index
            If UBound(arrPair) = 1 Then
                sSourceName = Trim(arrPair(0))
                
                ' Convert Destination Column Index to Long integer
                On Error Resume Next
                lDestIndex = CLng(Trim(arrPair(1)))
                On Error GoTo ErrorHandler ' Reset Error Handler

                ' --- Find Source Column by Name ---
                lSourceCol = 0 ' Reset source column index
                For lCol = 1 To wsSource.Cells(lHeaderRow, Columns.Count).End(xlToLeft).Column
                    ' Case-insensitive comparison of header names
                    If StrComp(Trim(wsSource.Cells(lHeaderRow, lCol).Value), sSourceName, vbTextCompare) = 0 Then
                        lSourceCol = lCol
                        Exit For
                    End If
                Next lCol

                If lSourceCol > 0 And lDestIndex > 0 Then
                    
                    ' --- Determine the last row with data in the source column ---
                    lLastRow = wsSource.Cells(Rows.Count, lSourceCol).End(xlUp).Row
                    
                    If lLastRow > lHeaderRow Then
                        ' Copy Data (excluding header row)
                        ' Source Range: From the cell below the Header to the last row
                        ' Destination Range: Starting from the cell below the Header
                        
                        ' Copy Values
                        wsDest.Range(wsDest.Cells(lHeaderRow + 1, lDestIndex), wsDest.Cells(lLastRow, lDestIndex)).Value = _
                        wsSource.Range(wsSource.Cells(lHeaderRow + 1, lSourceCol), wsSource.Cells(lLastRow, lSourceCol)).Value
                    Else
                        ' Log if no data is found for this column
                        sErrorLog = sErrorLog & "Warning: No data found for column '" & sSourceName & "'. "
                    End If
                ElseIf lSourceCol = 0 Then
                    ' Log if source column is not found
                    sErrorLog = sErrorLog & "Error: Source column not found: '" & sSourceName & "'. "
                    CopyDataByColumnName = "Error: Missing Source Column" ' Set error status
                ElseIf lDestIndex = 0 Then
                     ' Log if destination index is invalid
                    sErrorLog = sErrorLog & "Error: Invalid destination index for '" & sSourceName & "'. "
                    CopyDataByColumnName = "Error: Invalid Dest Index" ' Set error status
                End If
            End If
        End If
    Next
    
    ' If there were non-critical warnings, append them to the success message
    If Len(sErrorLog) > 0 And CopyDataByColumnName = "Success" Then
        CopyDataByColumnName = "Success with Warnings: " & sErrorLog
    End If

    ' --- 4. Save and Close ---
    wbDest.Save
    ' Close source and destination files without showing alerts
    wbSource.Close SaveChanges:=False
    wbDest.Close SaveChanges:=False

    ' --- 5. Cleanup ---
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    Exit Function

ErrorHandler:
    ' Handle runtime errors
    sErrorLog = sErrorLog & "Runtime Error: " & Err.Description & " (" & Err.Number & ") on line " & Erl & ". "
    CopyDataByColumnName = "Fatal Error: " & sErrorLog ' Set error status with details
    
    ' Ensure settings are reset even on error
    Application.ScreenUpdating = True
    Application.DisplayAlerts = True
    
    ' Close open workbooks (attempt gracefully)
    On Error Resume Next
    If Not wbSource Is Nothing Then wbSource.Close SaveChanges:=False
    If Not wbDest Is Nothing Then wbDest.Close SaveChanges:=False

End Function

' Example of calling the function (for internal testing):
' Sub TestCopy()
'     Dim result As String
'     result = CopyDataByColumnName "C:\Data\SourceFile.xlsx", _
'                                   "C:\Data\DestinationFile.xlsx", _
'                                   "Product Name,1;Sale Price,3;Code,5;NonExistentColumn,10"
'     MsgBox "Macro Result: " & result
' End Sub

‚öôÔ∏è H∆∞·ªõng d·∫´n L·∫•y Gi√° tr·ªã Tr·∫£ v·ªÅ trong Power Automate Desktop (PAD)
V√¨ b·∫°n ƒë√£ thay ƒë·ªïi Sub th√†nh Function, PAD c√≥ th·ªÉ l·∫•y ƒë∆∞·ª£c gi√° tr·ªã tr·∫£ v·ªÅ.
1. Thi·∫øt l·∫≠p trong PAD
S·ª≠ d·ª•ng h√†nh ƒë·ªông "Run Excel macro" v√† c·∫•u h√¨nh nh∆∞ sau:
| Thu·ªôc t√≠nh | C·∫•u h√¨nh | Ghi ch√∫ |
|---|---|---|
| Excel instance | %ExcelInstance% | Phi√™n b·∫£n Excel ƒë√£ m·ªü |
| Macro name | CopyDataByColumnName | T√™n c·ªßa Function |
| Macro arguments | 3 ƒë·ªëi s·ªë (SourcePath, DestPath, MappingString) | Nh∆∞ ƒë√£ gi·∫£i th√≠ch tr∆∞·ªõc ƒë√≥ |
| Macro result | %MacroResult% | ƒê√¢y l√† bi·∫øn quan tr·ªçng! PAD s·∫Ω l∆∞u tr·ªØ gi√° tr·ªã tr·∫£ v·ªÅ (Success, Fatal Error: ..., ho·∫∑c Success with Warnings: ...) c·ªßa Function v√†o bi·∫øn n√†y. |
2. X·ª≠ l√Ω K·∫øt qu·∫£ Tr·∫£ v·ªÅ trong PAD
Sau khi ch·∫°y macro, b·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng h√†nh ƒë·ªông If (ƒêi·ªÅu ki·ªán) ƒë·ªÉ ki·ªÉm tra bi·∫øn %MacroResult%:
... (C√°c b∆∞·ªõc M·ªü Excel v√† Ch·∫°y Macro)

IF %MacroResult% CONTAINS 'Fatal Error:'
    DISPLAY MESSAGE "L·ªói nghi√™m tr·ªçng khi ch·∫°y Macro: %MacroResult%"
    STOP FLOW
ELSE IF %MacroResult% CONTAINS 'Success'
    DISPLAY MESSAGE "Macro ch·∫°y th√†nh c√¥ng!"
    LOG MESSAGE "K·∫øt qu·∫£: %MacroResult%" (N·∫øu c√≥ Warnings, log s·∫Ω ghi l·∫°i)
ELSE
    ' X·ª≠ l√Ω c√°c tr∆∞·ªùng h·ª£p kh√°c (th∆∞·ªùng kh√¥ng x·∫£y ra n·∫øu ErrorHandler ho·∫°t ƒë·ªông t·ªët)
END

B·∫°n c√≥ mu·ªën t√¥i gi√∫p b·∫°n t·∫°o m·ªôt chu·ªói Mapping (√°nh x·∫°) c·ª• th·ªÉ d·ª±a tr√™n t√™n c·ªôt v√† index c·ªôt m√† b·∫°n c√≥ kh√¥ng?
