Public Function ConsolidateMultipleFiles(ByVal sourceFilePaths As String, ByVal targetFilePath As String, ByVal columnsToCopy As String) As String
    Dim sourceFiles() As String
    Dim sourceWorkbook As Workbook
    Dim targetWorkbook As Workbook
    Dim sourceSheet As Worksheet
    Dim targetSheet As Worksheet
    Dim sourceColumns() As String
    Dim targetCol As Integer
    Dim lastRowSource As Long
    Dim lastRowTarget As Long
    Dim sourceData As Variant
    Dim i As Integer, j As Integer
    Dim errorMessages As String

    On Error GoTo ErrorHandler

    ' Ph√¢n t√°ch danh s√°ch ƒë∆∞·ªùng d·∫´n file ngu·ªìn
    sourceFiles = Split(sourceFilePaths, ",")

    ' M·ªü file ƒë√≠ch
    Set targetWorkbook = Workbooks.Open(targetFilePath)
    Set targetSheet = targetWorkbook.Sheets(2) ' X√°c ƒë·ªãnh sheet trong file ƒë√≠ch

    ' Chuy·ªÉn t√™n c·ªôt t·ª´ chu·ªói th√†nh m·∫£ng
    sourceColumns = Split(columnsToCopy, ",")

    ' X√≥a d·ªØ li·ªáu c≈© nh∆∞ng gi·ªØ l·∫°i ti√™u ƒë·ªÅ
    If Application.CountA(targetSheet.Rows(2)) > 0 Then
        targetSheet.Rows("2:" & targetSheet.Rows.Count).ClearContents
    End If

    ' X√≥a d·ªØ li·ªáu t·ª´ h√†ng 4 tr·ªü ƒëi ·ªü c·ªôt A,B
    Dim lastRowToClear As Long
    lastRowToClear = targetSheet.Cells(targetSheet.Rows.Count, 1).End(xlUp).Row
    If lastRowToClear >= 4 Then
        targetSheet.Range("A4:B" & lastRowToClear).ClearContents
    End If

    ' Duy·ªát qua t·ª´ng file ngu·ªìn
    For i = LBound(sourceFiles) To UBound(sourceFiles)
        On Error Resume Next
        Set sourceWorkbook = Workbooks.Open(Trim(sourceFiles(i)))
        If Err.Number <> 0 Then
            errorMessages = errorMessages & "Failed to open file: " & sourceFiles(i) & " - " & Err.Description & vbNewLine
            Err.Clear
            GoTo NextFile
        End If
        On Error GoTo 0

        Set sourceSheet = sourceWorkbook.Sheets(1) ' L·∫•y sheet ƒë·∫ßu ti√™n c·ªßa file ngu·ªìn

        ' X√°c ƒë·ªãnh d√≤ng cu·ªëi c√πng c·ªßa d·ªØ li·ªáu trong file ngu·ªìn
        lastRowSource = sourceSheet.Cells(sourceSheet.Rows.Count, 1).End(xlUp).Row

        ' X√°c ƒë·ªãnh d√≤ng cu·ªëi c√πng c·ªßa d·ªØ li·ªáu trong file ƒë√≠ch
        lastRowTarget = targetSheet.Cells(targetSheet.Rows.Count, 1).End(xlUp).Row + 1

        ' Duy·ªát qua t·ª´ng c·ªôt c·∫ßn sao ch√©p
        For j = LBound(sourceColumns) To UBound(sourceColumns)
            ' T√¨m c·ªôt ngu·ªìn d·ª±a v√†o t√™n c·ªôt
            Dim sourceCol As Integer
            On Error Resume Next
            sourceCol = Application.Match(sourceColumns(j), sourceSheet.Rows(1), 0)
            If Err.Number <> 0 Then
                errorMessages = errorMessages & "Missing column '" & sourceColumns(j) & "' in file: " & sourceFiles(i) & vbNewLine
                Err.Clear
                GoTo NextColumn
            End If
            On Error GoTo 0

            ' X√°c ƒë·ªãnh d√≤ng cu·ªëi c√πng c·ªßa d·ªØ li·ªáu trong c·ªôt ngu·ªìn
            lastRowSource = sourceSheet.Cells(sourceSheet.Rows.Count, sourceCol).End(xlUp).Row

            ' Sao ch√©p d·ªØ li·ªáu t·ª´ c·ªôt ngu·ªìn
            sourceData = sourceSheet.Range(sourceSheet.Cells(2, sourceCol), sourceSheet.Cells(lastRowSource, sourceCol)).Value

            ' T√¨m c·ªôt ƒë√≠ch d·ª±a tr√™n t√™n c·ªôt
            targetCol = Application.Match(sourceColumns(j), targetSheet.Rows(1), 0)

            If targetCol > 0 Then
                ' D√°n d·ªØ li·ªáu v√†o c·ªôt ƒë√≠ch
                targetSheet.Range(targetSheet.Cells(lastRowTarget, targetCol), _
                                  targetSheet.Cells(lastRowTarget + UBound(sourceData, 1) - 1, targetCol)).Value = sourceData
            Else
                errorMessages = errorMessages & "Error: Target column '" & sourceColumns(j) & "' not found in target file." & vbNewLine
            End If

NextColumn:
        Next j

        ' ƒê√≥ng file ngu·ªìn
        sourceWorkbook.Close False
NextFile:
    Next i

    ' L∆∞u v√† ƒë√≥ng file ƒë√≠ch
    targetWorkbook.Save
    targetWorkbook.Close True

    ' Ki·ªÉm tra n·∫øu c√≥ l·ªói x·∫£y ra
    If errorMessages <> "" Then
        ConsolidateMultipleFiles = "Completed with errors:" & vbNewLine & errorMessages
    Else
        ConsolidateMultipleFiles = "Success: Data has been copied from multiple source files to the target file."
    End If

    Exit Function

ErrorHandler:
    ConsolidateMultipleFiles = "Error: An error occurred during execution: " & Err.Description

CleanUp:
    ' ƒê√≥ng file n·∫øu c·∫ßn thi·∫øt
    If Not sourceWorkbook Is Nothing Then sourceWorkbook.Close False
    If Not targetWorkbook Is Nothing Then targetWorkbook.Close True
End Function
‚â†===========‚â†=={{={{=========
D∆∞·ªõi ƒë√¢y l√† phi√™n b·∫£n c·∫≠p nh·∫≠t c·ªßa ƒëo·∫°n m√£ VBA, b·ªï sung x·ª≠ l√Ω l·ªói trong tr∆∞·ªùng h·ª£p **m·ªôt ho·∫∑c nhi·ªÅu file kh√¥ng th·ªÉ copy ƒë∆∞·ª£c d·ªØ li·ªáu**. N·∫øu x·∫£y ra l·ªói, ch∆∞∆°ng tr√¨nh s·∫Ω ghi l·ªói k√®m t√™n file b·ªã l·ªói v√†o danh s√°ch, sau ƒë√≥ xu·∫•t ra m·ªôt chu·ªói th√¥ng b√°o l·ªói t·ªïng h·ª£p.

### **M√£ VBA ƒë√£ c·∫≠p nh·∫≠t**
```vba
Public Function ConsolidateMultipleFiles(ByVal sourceFilePaths As String, ByVal targetFilePath As String, ByVal columnsToCopy As String) As String
    Dim sourceFiles() As String
    Dim sourceWorkbook As Workbook
    Dim targetWorkbook As Workbook
    Dim sourceSheet As Worksheet
    Dim targetSheet As Worksheet
    Dim sourceColumns() As String
    Dim targetCol As Integer
    Dim lastRowSource As Long
    Dim lastRowTarget As Long
    Dim sourceData As Variant
    Dim i As Integer, j As Integer
    Dim errorMessages As String

    On Error GoTo ErrorHandler

    ' Ph√¢n t√°ch danh s√°ch ƒë∆∞·ªùng d·∫´n file ngu·ªìn
    sourceFiles = Split(sourceFilePaths, ",")

    ' M·ªü file ƒë√≠ch
    Set targetWorkbook = Workbooks.Open(targetFilePath)
    Set targetSheet = targetWorkbook.Sheets(2) ' X√°c ƒë·ªãnh sheet trong file ƒë√≠ch

    ' Chuy·ªÉn t√™n c·ªôt t·ª´ chu·ªói th√†nh m·∫£ng
    sourceColumns = Split(columnsToCopy, ",")

    ' X√≥a d·ªØ li·ªáu c≈© nh∆∞ng gi·ªØ l·∫°i ti√™u ƒë·ªÅ
    If Application.CountA(targetSheet.Rows(2)) > 0 Then
        targetSheet.Rows("2:" & targetSheet.Rows.Count).ClearContents
    End If

    ' X√≥a d·ªØ li·ªáu t·ª´ h√†ng 4 tr·ªü ƒëi ·ªü c·ªôt A,B
    Dim lastRowToClear As Long
    lastRowToClear = targetSheet.Cells(targetSheet.Rows.Count, 1).End(xlUp).Row
    If lastRowToClear >= 4 Then
        targetSheet.Range("A4:B" & lastRowToClear).ClearContents
    End If

    ' Duy·ªát qua t·ª´ng file ngu·ªìn
    For i = LBound(sourceFiles) To UBound(sourceFiles)
        On Error Resume Next
        Set sourceWorkbook = Workbooks.Open(Trim(sourceFiles(i)))
        If Err.Number <> 0 Then
            errorMessages = errorMessages & "Failed to open file: " & sourceFiles(i) & " - " & Err.Description & vbNewLine
            Err.Clear
            GoTo NextFile
        End If
        On Error GoTo 0

        Set sourceSheet = sourceWorkbook.Sheets(1) ' L·∫•y sheet ƒë·∫ßu ti√™n c·ªßa file ngu·ªìn

        ' X√°c ƒë·ªãnh d√≤ng cu·ªëi c√πng c·ªßa d·ªØ li·ªáu trong file ngu·ªìn
        lastRowSource = sourceSheet.Cells(sourceSheet.Rows.Count, 1).End(xlUp).Row

        ' X√°c ƒë·ªãnh d√≤ng cu·ªëi c√πng c·ªßa d·ªØ li·ªáu trong file ƒë√≠ch
        lastRowTarget = targetSheet.Cells(targetSheet.Rows.Count, 1).End(xlUp).Row + 1

        ' Duy·ªát qua t·ª´ng c·ªôt c·∫ßn sao ch√©p
        For j = LBound(sourceColumns) To UBound(sourceColumns)
            ' T√¨m c·ªôt ngu·ªìn d·ª±a v√†o t√™n c·ªôt
            Dim sourceCol As Integer
            On Error Resume Next
            sourceCol = Application.Match(sourceColumns(j), sourceSheet.Rows(1), 0)
            If Err.Number <> 0 Then
                errorMessages = errorMessages & "Missing column '" & sourceColumns(j) & "' in file: " & sourceFiles(i) & vbNewLine
                Err.Clear
                GoTo NextColumn
            End If
            On Error GoTo 0

            ' X√°c ƒë·ªãnh d√≤ng cu·ªëi c√πng c·ªßa d·ªØ li·ªáu trong c·ªôt ngu·ªìn
            lastRowSource = sourceSheet.Cells(sourceSheet.Rows.Count, sourceCol).End(xlUp).Row

            ' Sao ch√©p d·ªØ li·ªáu t·ª´ c·ªôt ngu·ªìn
            sourceData = sourceSheet.Range(sourceSheet.Cells(2, sourceCol), sourceSheet.Cells(lastRowSource, sourceCol)).Value

            ' T√¨m c·ªôt ƒë√≠ch d·ª±a tr√™n t√™n c·ªôt
            targetCol = Application.Match(sourceColumns(j), targetSheet.Rows(1), 0)

            If targetCol > 0 Then
                ' D√°n d·ªØ li·ªáu v√†o c·ªôt ƒë√≠ch
                targetSheet.Range(targetSheet.Cells(lastRowTarget, targetCol), _
                                  targetSheet.Cells(lastRowTarget + UBound(sourceData, 1) - 1, targetCol)).Value = sourceData
            Else
                errorMessages = errorMessages & "Error: Target column '" & sourceColumns(j) & "' not found in target file." & vbNewLine
            End If

NextColumn:
        Next j

        ' ƒê√≥ng file ngu·ªìn
        sourceWorkbook.Close False
NextFile:
    Next i

    ' L∆∞u v√† ƒë√≥ng file ƒë√≠ch
    targetWorkbook.Save
    targetWorkbook.Close True

    ' Ki·ªÉm tra n·∫øu c√≥ l·ªói x·∫£y ra
    If errorMessages <> "" Then
        ConsolidateMultipleFiles = "Completed with errors:" & vbNewLine & errorMessages
    Else
        ConsolidateMultipleFiles = "Success: Data has been copied from multiple source files to the target file."
    End If

    Exit Function

ErrorHandler:
    ConsolidateMultipleFiles = "Error: An error occurred during execution: " & Err.Description

CleanUp:
    ' ƒê√≥ng file n·∫øu c·∫ßn thi·∫øt
    If Not sourceWorkbook Is Nothing Then sourceWorkbook.Close False
    If Not targetWorkbook Is Nothing Then targetWorkbook.Close True
End Function
```

---

### **C√°c c·∫≠p nh·∫≠t quan tr·ªçng**
1. **X·ª≠ l√Ω l·ªói khi m·ªü file**:
   - N·∫øu m·ªôt file ngu·ªìn b·ªã l·ªói khi m·ªü, ch∆∞∆°ng tr√¨nh s·∫Ω ghi l·∫°i l·ªói k√®m t√™n file v√†o danh s√°ch `errorMessages`.
   - Ch∆∞∆°ng tr√¨nh **kh√¥ng d·ª´ng** khi g·∫∑p l·ªói m√† ti·∫øp t·ª•c v·ªõi file ti·∫øp theo.

2. **X·ª≠ l√Ω l·ªói khi kh√¥ng t√¨m th·∫•y c·ªôt trong file ngu·ªìn**:
   - N·∫øu kh√¥ng t√¨m th·∫•y c·ªôt (`sourceColumns(j)`) trong file ngu·ªìn, l·ªói s·∫Ω ƒë∆∞·ª£c ghi l·∫°i v√†o `errorMessages`.

3. **Xu·∫•t t·∫•t c·∫£ l·ªói sau khi ho√†n th√†nh**:
   - N·∫øu c√≥ l·ªói, ch∆∞∆°ng tr√¨nh s·∫Ω tr·∫£ v·ªÅ danh s√°ch l·ªói thay v√¨ ch·ªâ m·ªôt th√¥ng b√°o chung.

---

### **H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng**
1. **T·∫°o file `.bas`**:
   - L∆∞u ƒëo·∫°n m√£ v√†o **VBA Editor**, ch·ªçn module, nh·∫•p chu·ªôt ph·∫£i, ch·ªçn `Export File` v√† l∆∞u v·ªõi t√™n `ConsolidateFiles.bas`.

2. **T√≠ch h·ª£p v·ªõi UiPath**:
   - D√πng ho·∫°t ƒë·ªông **Invoke VBA**.
   - C·∫•u h√¨nh `Properties`:
     - **VBAScriptFilePath**: `C:\Scripts\ConsolidateFiles.bas`.
     - **EntryMethodName**: `"ConsolidateMultipleFiles"`.
     - **EntryMethodParameters**: `sourceFilePaths, targetFilePath, columnsToCopy`.

3. **Ki·ªÉm tra k·∫øt qu·∫£**:
   - N·∫øu c√≥ l·ªói, UiPath s·∫Ω nh·∫≠n th√¥ng b√°o v·ªõi danh s√°ch file b·ªã l·ªói.
   - N·∫øu kh√¥ng c√≥ l·ªói, d·ªØ li·ªáu s·∫Ω ƒë∆∞·ª£c h·ª£p nh·∫•t th√†nh c√¥ng.

---

### **V√≠ d·ª• k·∫øt qu·∫£ tr·∫£ v·ªÅ**
N·∫øu m·ªôt file kh√¥ng m·ªü ƒë∆∞·ª£c v√† m·ªôt c·ªôt kh√¥ng t·ªìn t·∫°i, UiPath s·∫Ω nh·∫≠n th√¥ng b√°o nh∆∞ sau:
```
Completed with errors:
Failed to open file: C:\Data\File1.xlsx - File not found
Missing column 'Sales' in file: C:\Data\File2.xlsx
```

N·∫øu t·∫•t c·∫£ ch·∫°y t·ªët:
```
Success: Data has been copied from multiple source files to the target file.
```

---

H√£y th·ª≠ nghi·ªám v√† cho t√¥i bi·∫øt n·∫øu b·∫°n c·∫ßn th√™m ƒëi·ªÅu ch·ªânh! üòä
