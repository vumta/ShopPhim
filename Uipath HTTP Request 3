DÆ°á»›i Ä‘Ã¢y lÃ  hÆ°á»›ng dáº«n **chi tiáº¿t tá»«ng bÆ°á»›c (step-by-step)** Ä‘á»ƒ xÃ¢y dá»±ng giáº£i phÃ¡p **Power Automate sá»­ dá»¥ng Child Flow káº¿t há»£p `Do Until` + `Queue`** nháº±m láº¥y táº¥t cáº£ file trong SharePoint bao gá»“m má»i cáº¥p subfolder.

---

# ğŸ“˜ Má»¤C TIÃŠU
- Gá»i Flow chÃ­nh tá»« **UiPath (HTTP trigger)**.
- Duyá»‡t Ä‘á»‡ quy toÃ n bá»™ thÆ° má»¥c SharePoint thÃ´ng qua ká»¹ thuáº­t **mÃ´ phá»ng Ä‘á»‡ quy** vá»›i `Queue`.
- **Flow con xá»­ lÃ½ tá»«ng folder**, Flow cha gom toÃ n bá»™ káº¿t quáº£ â†’ tráº£ vá» JSON danh sÃ¡ch file.

---

## ğŸ”¹ PHáº¦N 1 â€“ Táº O FLOW CON `Child_ProcessFolder`

### ğŸ¯ Chá»©c nÄƒng:
Nháº­n má»™t `FolderPath`, tráº£ vá»:
- `Files`: CÃ¡c file trong folder.
- `Subfolders`: CÃ¡c folder con (Ä‘Æ°á»ng dáº«n tÆ°Æ¡ng Ä‘á»‘i).

---

### ğŸ”§ BÆ°á»›c 1 â€“ Táº¡o Flow má»›i
- TÃªn: **Child_ProcessFolder**
- Kiá»ƒu: **Instant cloud flow**
- Trigger: **Manually trigger a flow**
  - ThÃªm input: `FolderPath` â€“ kiá»ƒu **string**

---

### ğŸ”§ BÆ°á»›c 2 â€“ Gá»­i HTTP Request Ä‘áº¿n SharePoint

**Action**: `Send an HTTP request to SharePoint`  
- Site Address: chá»n site tÆ°Æ¡ng á»©ng  
- Method: `GET`  
- Uri:
```http
_api/web/GetFolderByServerRelativeUrl('@{triggerBody()['FolderPath']}')?$expand=Files,Folders
```

---

### ğŸ”§ BÆ°á»›c 3 â€“ Parse JSON káº¿t quáº£

- Content: `body('Send_an_HTTP_request_to_SharePoint')`
- Schema: sá»­ dá»¥ng "Generate from sample" vá»›i máº«u sau:
```json
{
  "Files": { "results": [] },
  "Folders": { "results": [] }
}
```

---

### ğŸ”§ BÆ°á»›c 4 â€“ Láº¥y danh sÃ¡ch `Files` vÃ  `Subfolders`

**Compose Files**:  
```json
@body('Parse_JSON')?['Files']?['results']
```

**Select Subfolders**:
- From: `body('Parse_JSON')?['Folders']?['results']`
- Map:  
  - Name: `item()?['Name']`  
  - Path: `item()?['ServerRelativeUrl']`

---

### ğŸ”§ BÆ°á»›c 5 â€“ Káº¿t thÃºc Flow con

**Action**: `Respond to a PowerApp or flow`
- Outputs:
  - `Files`: tá»« Compose Files
  - `Subfolders`: tá»« Select Subfolders

---

## ğŸ”¹ PHáº¦N 2 â€“ Táº O FLOW CHA `Main_GetAllFiles`

### ğŸ¯ Chá»©c nÄƒng:
Nháº­n 1 folder tá»« UiPath â†’ duyá»‡t subfolders báº±ng `Queue` â†’ gá»i Flow con â†’ gom toÃ n bá»™ `Files`.

---

### ğŸ”§ BÆ°á»›c 1 â€“ Táº¡o Flow má»›i
- TÃªn: **Main_GetAllFiles**
- Trigger: **When an HTTP request is received**
  - Request Body Schema:
```json
{
  "FolderPath": "string"
}
```

---

### ğŸ”§ BÆ°á»›c 2 â€“ Khá»Ÿi táº¡o biáº¿n

- **Initialize variable â€“ PendingFolders**  
  - Type: **Array**  
  - Value:
```json
[
  "@{triggerBody()?['FolderPath']}"
]
```

- **Initialize variable â€“ AllFiles**  
  - Type: **Array**
  - Value: `[]`

---

### ğŸ”§ BÆ°á»›c 3 â€“ `Do Until` loop: Khi `PendingFolders` rá»—ng

**Condition**:  
```plaintext
length(variables('PendingFolders')) is equal to 0
```

---

### BÃªn trong `Do Until`

#### ğŸ”¸ 1. Get Current Folder
**Compose â€“ CurrentFolder**:
```plaintext
first(variables('PendingFolders'))
```

#### ğŸ”¸ 2. Gá»i Flow con
**Run Child Flow â€“ Child_ProcessFolder**
- Input: `FolderPath = outputs('CurrentFolder')`

#### ğŸ”¸ 3. Append Files vÃ o AllFiles
```json
union(variables('AllFiles'), outputs('Child_ProcessFolder')?['Files'])
```

#### ğŸ”¸ 4. Cáº­p nháº­t PendingFolders
```json
union(
  skip(variables('PendingFolders'), 1),
  outputs('Child_ProcessFolder')?['Subfolders']
)
```

---

### ğŸ”§ BÆ°á»›c 4 â€“ Sau khi hoÃ n táº¥t vÃ²ng láº·p

**Response**:  
```json
{
  "files": "@variables('AllFiles')"
}
```

> Gá»­i toÃ n bá»™ danh sÃ¡ch file cho UiPath.

---

## ğŸ“ GHI CHÃš QUAN TRá»ŒNG

| LÆ°u Ã½ | Ná»™i dung |
|-------|---------|
| ğŸ”¹ ÄÆ°á»ng dáº«n `FolderPath` | LÃ  **ServerRelativeUrl**, khÃ´ng cÃ³ dáº¥u `/` Ä‘áº§u dÃ²ng. Ex: `"Shared Documents/BÃ¡o cÃ¡o"` |
| ğŸ”¹ KÃ½ tá»± Unicode | Náº¿u cÃ³ tiáº¿ng Nháº­t, tiáº¿ng Viá»‡t,... cáº§n `uriComponent()` khi gá»i API |
| ğŸ”¹ Äá»‡ quy mÃ´ phá»ng | KhÃ´ng gá»i láº¡i chÃ­nh Flow con â†’ dÃ¹ng `Queue` Ä‘á»ƒ xá»­ lÃ½ nhiá»u cáº¥p folder |
| ğŸ”¹ Performance | CÃ³ thá»ƒ cáº£i thiá»‡n báº±ng cÃ¡ch gá»i song song nhiá»u Flow con náº¿u cáº§n |

---

Náº¿u báº¡n muá»‘n mÃ¬nh táº¡o sáºµn 2 file `.zip` máº«u cho 2 Flow Ä‘á»ƒ báº¡n import, chá»‰ cáº§n upload 1 file `.txt` báº¥t ká»³, mÃ¬nh sáº½ dÃ¹ng Ä‘Ã³ Ä‘á»ƒ Ä‘Ã­nh kÃ¨m file. Hoáº·c báº¡n muá»‘n xem thÃªm vÃ­ dá»¥ cho pháº§n `Parse JSON`, mÃ¬nh cÅ©ng cÃ³ thá»ƒ táº¡o máº«u cá»¥ thá»ƒ cho báº¡n.
