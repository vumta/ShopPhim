ƒê√∫ng r·ªìi, ƒë·ªÉ x·ª≠ l√Ω nhanh v√† hi·ªáu qu·∫£ **90.000 d√≤ng d·ªØ li·ªáu Excel** b·∫±ng **Office Script v√† Power Automate**, ch√∫ng ta c·∫ßn t·ªëi ∆∞u **c·∫£ code Office Script l·∫´n lu·ªìng x·ª≠ l√Ω trong Power Automate**.

---

## ‚úÖ M·ª•c ti√™u:
- **D√°n d·ªØ li·ªáu 1 c·ªôt** v√†o **file ƒë√≠ch** kh√¥ng d√πng Table.
- T√¨m ƒë√∫ng c·ªôt theo t√™n (·ªü d√≤ng 2).
- D√°n d·ªØ li·ªáu b·∫Øt ƒë·∫ßu t·ª´ d√≤ng cu·ªëi c√πng + 1.
- T·ªëi ∆∞u hi·ªáu su·∫•t khi d·ªØ li·ªáu l·ªõn: **90.000 d√≤ng**.

---

## ‚úÖ GI·∫¢I PH√ÅP T·ªêI ∆ØU H√ìA TO√ÄN DI·ªÜN

---

### 1. ‚úçÔ∏è **Office Script t·ªëi ∆∞u - phi√™n b·∫£n final**

```ts
function main(workbook: ExcelScript.Workbook, inputData: ColumnData): void {
  const sheet = workbook.getActiveWorksheet();

  const maxCols = 100;
  const headerRow = sheet.getRangeByIndexes(1, 0, 1, maxCols).getValues()[0];

  // 1. Map t√™n c·ªôt sang ch·ªâ s·ªë
  const colMap: Record<string, number> = {};
  for (let i = 0; i < headerRow.length; i++) {
    const header = headerRow[i]?.toString().trim();
    if (header) colMap[header] = i;
  }

  const colIndex = colMap[inputData.columnName];
  if (colIndex === undefined) {
    console.log(`Kh√¥ng t√¨m th·∫•y c·ªôt: ${inputData.columnName}`);
    return;
  }

  // 2. X√°c ƒë·ªãnh d√≤ng cu·ªëi ch·ª©a d·ªØ li·ªáu trong c·ªôt
  const estimatedMaxRow = 100000; // c√≥ th·ªÉ tƒÉng n·∫øu c·∫ßn
  const colRange = sheet.getRangeByIndexes(2, colIndex, estimatedMaxRow, 1);
  const colValues = colRange.getValues();

  let lastDataRow = 2;
  for (let i = colValues.length - 1; i >= 0; i--) {
    const value = colValues[i][0];
    if (value !== null && value !== "") {
      lastDataRow = i + 3;
      break;
    }
  }

  // 3. D√°n gi√° tr·ªã t·ª´ inputData.values
  const numRows = inputData.values.length;
  if (numRows === 0) return;

  const targetRange = sheet.getRangeByIndexes(lastDataRow, colIndex, numRows, 1);
  targetRange.setValues(inputData.values);
}

type ColumnData = {
  columnName: string;
  values: (string | number | boolean)[][];
};
```

---

### ‚úÖ T·ªëi ∆∞u hi·ªáu su·∫•t:
- ‚úÖ Kh√¥ng d√πng `getUsedRange()` (v√¨ ch·∫≠m khi file l·ªõn).
- ‚úÖ Truy xu·∫•t tr·ª±c ti·∫øp theo `getRangeByIndexes()` ‚Äî hi·ªáu su·∫•t cao.
- ‚úÖ D√°n to√†n b·ªô block d·ªØ li·ªáu 1 l·∫ßn duy nh·∫•t (`setValues()`), kh√¥ng d√πng v√≤ng l·∫∑p.

---

### 2. ‚öôÔ∏è Power Automate: X·ª≠ l√Ω d·ªØ li·ªáu l·ªõn m∆∞·ª£t m√†

#### **T·ªïng quan c√°c b∆∞·ªõc:**

| B∆∞·ªõc | T√°c v·ª• |
|------|--------|
| 1Ô∏è‚É£ | **Trigger**: Khi c√≥ file m·ªõi ho·∫∑c th·ªß c√¥ng |
| 2Ô∏è‚É£ | **List files** trong th∆∞ m·ª•c (n·∫øu nhi·ªÅu file) |
| 3Ô∏è‚É£ | **Apply to each** file |
| 4Ô∏è‚É£ | **Read file**: Get File Content |
| 5Ô∏è‚É£ | **Run Office Script**: Tr√≠ch xu·∫•t c·ªôt d·ªØ li·ªáu c·∫ßn thi·∫øt |
| 6Ô∏è‚É£ | **Parse JSON** d·ªØ li·ªáu t·ª´ng c·ªôt |
| 7Ô∏è‚É£ | **Run Office Script (d√°n)**: G·ªçi script d√°n t·ª´ng c·ªôt v√†o file ƒë√≠ch |
| ‚úÖ | L·∫∑p v·ªõi t·ª´ng c·ªôt n·∫øu c·∫ßn (nhi·ªÅu l·∫ßn g·ªçi script d√°n) |

---

### üß© JSON m·∫´u ƒë·ªÉ **Parse** tr∆∞·ªõc khi g·ªçi script d√°n:

```json
{
  "columnName": "Ph√≤ng ban",
  "values": [["IT"], ["HR"], ["Finance"]]
}
```

Trong Power Automate:
- D√πng **action `Parse JSON`** ƒë·ªÉ ph√¢n t√≠ch input n√†y (c√≥ th·ªÉ l·∫•y m·∫´u t·ª´ response c·ªßa script extract).
- Sau ƒë√≥ t√°ch `columnName` v√† `values` ƒë·ªÉ ƒë∆∞a v√†o script `Run script` d√°n d·ªØ li·ªáu.

---

### üß† M·∫πo x·ª≠ l√Ω 90.000 d√≤ng nhanh trong Power Automate:

- **Kh√¥ng g·ªçi Office Script nhi·ªÅu l·∫ßn**: N√™n gom d·ªØ li·ªáu t·ª´ng c·ªôt v√† d√°n 1 l·∫ßn.
- **Tr√°nh delay**: Power Automate s·∫Ω ch·∫≠m n·∫øu b·∫°n ch·∫°y h√†ng trƒÉm l·∫ßn g·ªçi Office Script ‚Äî gom v√† x·ª≠ l√Ω theo batch.
- **TƒÉng timeout (n·∫øu c·∫ßn)**: M·ªôt s·ªë action nh∆∞ `Run script` c√≥ th·ªÉ timeout, c·∫ßn chia nh·ªè n·∫øu qu√° l·ªõn (v√≠ d·ª• chia m·ªói l·∫ßn 30k row).
- **Theo d√µi log & error**: Ghi ra console trong script v√† check t·ª´ng `Run script` ƒë·ªÉ x√°c ƒë·ªãnh l·ªói n·∫øu c√≥.

---

### ‚úÖ N·∫øu c·∫ßn h·ªó tr·ª£ th√™m

- G·ª≠i b·∫°n **file `.zip` Flow m·∫´u** c√≥ s·∫µn action + script
- Script tr√≠ch xu·∫•t t·ª´ file ngu·ªìn (nhi·ªÅu c·ªôt)
- Script d√°n nhi·ªÅu c·ªôt c√πng l√∫c

C·ª© n√≥i m√¨nh h·ªó tr·ª£ ƒë√≥ng g√≥i g·ª≠i b·∫°n!

---

B·∫°n mu·ªën m√¨nh **g·ª≠i s·∫µn file `.zip` Power Automate Flow m·∫´u** + **script Office ƒë·∫ßy ƒë·ªß** kh√¥ng? M√¨nh s·∫Ω so·∫°n s·∫µn ƒë·ªÉ b·∫°n ch·ªâ c·∫ßn import v√† d√πng lu√¥n!
