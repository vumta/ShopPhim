Cháº¯c cháº¯n rá»“i! DÆ°á»›i Ä‘Ã¢y lÃ  hÆ°á»›ng dáº«n chi tiáº¿t **tá»«ng bÆ°á»›c** Ä‘á»ƒ báº¡n xá»­ lÃ½ **chia batch dá»¯ liá»‡u vÃ  dÃ¡n vÃ o Excel** báº±ng **Power Automate + Office Script**, Ä‘áº£m báº£o trÃ¡nh lá»—i `timeout` khi xá»­ lÃ½ dá»¯ liá»‡u lá»›n (vÃ­ dá»¥ 90.000 dÃ²ng).

---

## ğŸ¯ **Má»¤C TIÃŠU**
- Báº¡n Ä‘Ã£ trÃ­ch xuáº¥t Ä‘Æ°á»£c dá»¯ liá»‡u tá»« Excel nguá»“n (qua Office Script), má»—i cá»™t cÃ³ dáº¡ng:
```json
{
  "columnName": "PhÃ²ng ban",
  "values": [["IT"], ["HR"], ["Finance"], ...]
}
```

- Báº¡n cáº§n **chia nhá» máº£ng nÃ y theo batch (vÃ­ dá»¥ 500 dÃ²ng)** vÃ  gá»i Office Script nhiá»u láº§n Ä‘á»ƒ **dÃ¡n nhanh & trÃ¡nh lá»—i timeout**.

---

## âœ… **Cáº¤U TRÃšC FLOW Tá»”NG QUÃT**

1. **Trigger** â€“ Tuá»³ chá»n
2. **Get file content**
3. **Run script: TrÃ­ch xuáº¥t data tá»« Excel nguá»“n**
4. **Parse JSON káº¿t quáº£**
5. **Apply to each column**
   - Chia data thÃ nh cÃ¡c batch nhá»
   - Táº¡o tá»«ng batch object: `{ columnName, values: [...] }`
   - Append vÃ o array `batches`
6. **Apply to each batch**
   - Gá»i Office Script dÃ¡n batch data

---

## ğŸ”§ **CHI TIáº¾T CÃC BÆ¯á»šC**

---

### âš™ï¸ B1 â€“ Khá»Ÿi táº¡o biáº¿n

| TÃªn biáº¿n        | Kiá»ƒu       | GiÃ¡ trá»‹ khá»Ÿi táº¡o |
|----------------|------------|------------------|
| `batches`       | Array      | `[]`             |
| `currentBatch`  | Array      | `[]`             |
| `batchSize`     | Integer    | `500`            |

---

### ğŸ” B2 â€“ Apply to each `column` trong máº£ng dá»¯ liá»‡u

- Duyá»‡t tá»«ng column object cÃ³ dáº¡ng:
```json
{
  "columnName": "PhÃ²ng ban",
  "values": [["IT"], ["HR"], ["Finance"], ...]
}
```

**Trong Apply nÃ y:**

#### ğŸ§± Step 1: Set biáº¿n `colName` = `items('Current_item')?['columnName']`  
â†’ Äá»ƒ biáº¿t Ä‘ang xá»­ lÃ½ cá»™t nÃ o

#### ğŸ§± Step 2: Initialize `currentBatch` = `[]`

#### ğŸ” Step 3: Apply to each `rowItem` in `items('Current_item')?['values']`

**Trong vÃ²ng láº·p nÃ y:**

- **Append to array variable** â†’ `currentBatch`  
  Value: `items('Current_item_2')` *(tá»©c má»—i dÃ²ng dá»¯ liá»‡u, dáº¡ng `["IT"]`)*

- **Kiá»ƒm tra batch Ä‘á»§ lá»›n chÆ°a:**  
  Condition: `length(variables('currentBatch'))` **`is greater than or equal to`** `variables('batchSize')`

  âœ… Náº¿u Ä‘Ãºng:
  - **Append to array variable** `batches`  
    Value:
    ```plaintext
    json(
      concat(
        '{ "columnName": "', variables('colName'), '", "values": ',
        string(variables('currentBatch')), ' }'
      )
    )
    ```

  - **Set `currentBatch` láº¡i thÃ nh []**

âœ… **Sau vÃ²ng láº·p**, thÃªm Ä‘oáº¡n kiá»ƒm tra **náº¿u cÃ²n dÆ° batch nhá» thÃ¬ cÅ©ng append**:

- Condition: `length(variables('currentBatch')) > 0`

â†’ Náº¿u Ä‘Ãºng â†’ Append vÃ o `batches` nhÆ° á»Ÿ trÃªn.

---

### âœ… Káº¿t quáº£ sau B2:  
Biáº¿n `batches` chá»©a danh sÃ¡ch cÃ¡c batch nhá» nhÆ°:

```json
[
  { "columnName": "PhÃ²ng ban", "values": [["IT"], ["HR"], ["Finance"]] },
  { "columnName": "PhÃ²ng ban", "values": [["QA"], ["Admin"], ["Dev"]] },
  ...
]
```

---

### âš™ï¸ B3 â€“ DÃ¡n tá»«ng batch

- **Apply to each** `items('batches')`

â†’ Gá»i Office Script dÃ¡n dá»¯ liá»‡u:

- Script Input:
```json
{
  "columns": [
    {
      "columnName": "@items('Current_batch')?['columnName']",
      "values": @items('Current_batch')?['values']
    }
  ]
}
```

Hoáº·c náº¿u script báº¡n dÃ¹ng input chá»‰ nháº­n 1 object `columnName` + `values`, thÃ¬ truyá»n trá»±c tiáº¿p.

---

## ğŸ§  Gá»¢I Ã:

- Chia batch 500â€“1000 tÃ¹y theo Ä‘á»™ lá»›n file Ä‘Ã­ch (Excel Online á»•n Ä‘á»‹nh hÆ¡n Excel Desktop)
- CÃ³ thá»ƒ gá»™p nhiá»u batch vÃ o 1 láº§n gá»i script náº¿u chÃºng **khÃ¡c cá»™t** Ä‘á»ƒ tá»‘i Æ°u

---

Náº¿u báº¡n cáº§n:
- File `.zip` máº«u Power Automate
- áº¢nh sÆ¡ Ä‘á»“ Flow
- Script gá»™p nhiá»u cá»™t trong 1 láº§n batch

ğŸ‘‰ Cá»© nÃ³i nhÃ©, mÃ¬nh gá»­i ngay!
