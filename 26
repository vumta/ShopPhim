Cháº¯c cháº¯n rá»“i! DÆ°á»›i Ä‘Ã¢y lÃ  hÆ°á»›ng dáº«n chi tiáº¿t **tá»«ng bÆ°á»›c** Ä‘á»ƒ báº¡n xá»­ lÃ½ **chia batch dá»¯ liá»‡u vÃ  dÃ¡n vÃ o Excel** báº±ng **Power Automate + Office Script**, Ä‘áº£m báº£o trÃ¡nh lá»—i `timeout` khi xá»­ lÃ½ dá»¯ liá»‡u lá»›n (vÃ­ dá»¥ 90.000 dÃ²ng).

---

## ğŸ¯ **Má»¤C TIÃŠU**
- Báº¡n Ä‘Ã£ trÃ­ch xuáº¥t Ä‘Æ°á»£c dá»¯ liá»‡u tá»« Excel nguá»“n (qua Office Script), má»—i cá»™t cÃ³ dáº¡ng:
```json
{
  "columnName": "PhÃ²ng ban",
  "values": [["IT"], ["HR"], ["Finance"], ...]
}
```

- Báº¡n cáº§n **chia nhá» máº£ng nÃ y theo batch (vÃ­ dá»¥ 500 dÃ²ng)** vÃ  gá»i Office Script nhiá»u láº§n Ä‘á»ƒ **dÃ¡n nhanh & trÃ¡nh lá»—i timeout**.

---

## âœ… **Cáº¤U TRÃšC FLOW Tá»”NG QUÃT**

1. **Trigger** â€“ Tuá»³ chá»n
2. **Get file content**
3. **Run script: TrÃ­ch xuáº¥t data tá»« Excel nguá»“n**
4. **Parse JSON káº¿t quáº£**
5. **Apply to each column**
   - Chia data thÃ nh cÃ¡c batch nhá»
   - Táº¡o tá»«ng batch object: `{ columnName, values: [...] }`
   - Append vÃ o array `batches`
6. **Apply to each batch**
   - Gá»i Office Script dÃ¡n batch data

---

## ğŸ”§ **CHI TIáº¾T CÃC BÆ¯á»šC**

---

### âš™ï¸ B1 â€“ Khá»Ÿi táº¡o biáº¿n

| TÃªn biáº¿n        | Kiá»ƒu       | GiÃ¡ trá»‹ khá»Ÿi táº¡o |
|----------------|------------|------------------|
| `batches`       | Array      | `[]`             |
| `currentBatch`  | Array      | `[]`             |
| `batchSize`     | Integer    | `500`            |

---

### ğŸ” B2 â€“ Apply to each `column` trong máº£ng dá»¯ liá»‡u

- Duyá»‡t tá»«ng column object cÃ³ dáº¡ng:
```json
{
  "columnName": "PhÃ²ng ban",
  "values": [["IT"], ["HR"], ["Finance"], ...]
}
```

**Trong Apply nÃ y:**

#### ğŸ§± Step 1: Set biáº¿n `colName` = `items('Current_item')?['columnName']`  
â†’ Äá»ƒ biáº¿t Ä‘ang xá»­ lÃ½ cá»™t nÃ o

#### ğŸ§± Step 2: Initialize `currentBatch` = `[]`

#### ğŸ” Step 3: Apply to each `rowItem` in `items('Current_item')?['values']`

**Trong vÃ²ng láº·p nÃ y:**

- **Append to array variable** â†’ `currentBatch`  
  Value: `items('Current_item_2')` *(tá»©c má»—i dÃ²ng dá»¯ liá»‡u, dáº¡ng `["IT"]`)*

- **Kiá»ƒm tra batch Ä‘á»§ lá»›n chÆ°a:**  
  Condition: `length(variables('currentBatch'))` **`is greater than or equal to`** `variables('batchSize')`

  âœ… Náº¿u Ä‘Ãºng:
  - **Append to array variable** `batches`  
    Value:
    ```plaintext
    json(
      concat(
        '{ "columnName": "', variables('colName'), '", "values": ',
        string(variables('currentBatch')), ' }'
      )
    )
    ```

  - **Set `currentBatch` láº¡i thÃ nh []**

âœ… **Sau vÃ²ng láº·p**, thÃªm Ä‘oáº¡n kiá»ƒm tra **náº¿u cÃ²n dÆ° batch nhá» thÃ¬ cÅ©ng append**:

- Condition: `length(variables('currentBatch')) > 0`

â†’ Náº¿u Ä‘Ãºng â†’ Append vÃ o `batches` nhÆ° á»Ÿ trÃªn.

---

### âœ… Káº¿t quáº£ sau B2:  
Biáº¿n `batches` chá»©a danh sÃ¡ch cÃ¡c batch nhá» nhÆ°:

```json
[
  { "columnName": "PhÃ²ng ban", "values": [["IT"], ["HR"], ["Finance"]] },
  { "columnName": "PhÃ²ng ban", "values": [["QA"], ["Admin"], ["Dev"]] },
  ...
]
```

---

### âš™ï¸ B3 â€“ DÃ¡n tá»«ng batch

- **Apply to each** `items('batches')`

â†’ Gá»i Office Script dÃ¡n dá»¯ liá»‡u:

- Script Input:
```json
{
  "columns": [
    {
      "columnName": "@items('Current_batch')?['columnName']",
      "values": @items('Current_batch')?['values']
    }
  ]
}
```

Hoáº·c náº¿u script báº¡n dÃ¹ng input chá»‰ nháº­n 1 object `columnName` + `values`, thÃ¬ truyá»n trá»±c tiáº¿p.

---

## ğŸ§  Gá»¢I Ã:

- Chia batch 500â€“1000 tÃ¹y theo Ä‘á»™ lá»›n file Ä‘Ã­ch (Excel Online á»•n Ä‘á»‹nh hÆ¡n Excel Desktop)
- CÃ³ thá»ƒ gá»™p nhiá»u batch vÃ o 1 láº§n gá»i script náº¿u chÃºng **khÃ¡c cá»™t** Ä‘á»ƒ tá»‘i Æ°u

---

Náº¿u báº¡n cáº§n:
- File `.zip` máº«u Power Automate
- áº¢nh sÆ¡ Ä‘á»“ Flow
- Script gá»™p nhiá»u cá»™t trong 1 láº§n batch

ğŸ‘‰ Cá»© nÃ³i nhÃ©, mÃ¬nh gá»­i ngay!
=================================================================================================================================================================================================
Tuyá»‡t vá»i! DÆ°á»›i Ä‘Ã¢y lÃ  **hÆ°á»›ng dáº«n chi tiáº¿t tá»«ng bÆ°á»›c** cho pháº§n **append batch cuá»‘i cÃ¹ng** cÃ²n dÆ° sau vÃ²ng láº·p â€” Ä‘á»ƒ Ä‘áº£m báº£o khÃ´ng máº¥t dá»¯ liá»‡u náº¿u tá»•ng sá»‘ dÃ²ng khÃ´ng chia háº¿t cho `batchSize`.

---

## ğŸ¯ TÃ¬nh huá»‘ng
Sau vÃ²ng láº·p Apply to each `rowItem`, cÃ³ thá»ƒ cÃ²n dÆ° vÃ i dÃ²ng nhá» (< `batchSize`) trong biáº¿n `currentBatch`.  
Báº¡n cáº§n **append pháº§n dÆ° nÃ y vÃ o `batches`**, Ä‘á»ƒ khÃ´ng bá»‹ bá» sÃ³t dá»¯ liá»‡u.

---

## âœ… HÆ°á»›ng dáº«n chi tiáº¿t pháº§n xá»­ lÃ½ "batch cuá»‘i cÃ¹ng"

### ğŸ“Œ 1. **ThÃªm Action `Condition`**  
> Ngay **sau vÃ²ng láº·p** `Apply to each rowItem`

#### âœï¸ Cáº¥u hÃ¬nh Ä‘iá»u kiá»‡n:

- **Condition**:
  - *Left:* `length(variables('currentBatch'))`
  - *Operator:* `is greater than`
  - *Right:* `0`

> Äiá»u kiá»‡n nÃ y kiá»ƒm tra: cÃ³ cÃ²n dÃ²ng nÃ o trong `currentBatch` khÃ´ng?

---

### âœ… 2. Náº¿u **`Yes`** â€“ CÃ²n dÆ° dá»¯ liá»‡u

#### â• ThÃªm Action: **Append to array variable**  
- **Name:** `batches`
- **Value:** *(Táº¡o chuá»—i JSON rá»“i parse láº¡i nhÆ° trÆ°á»›c)*

```plaintext
json(
  concat(
    '{ "columnName": "', variables('colName'), '", "values": ',
    string(variables('currentBatch')), ' }'
  )
)
```

---

### âŒ 3. Náº¿u **`No`** â€“ KhÃ´ng cÃ²n dá»¯ liá»‡u dÆ°  
â†’ **KhÃ´ng cáº§n thÃªm gÃ¬** cáº£.

---

### ğŸ“Œ Máº¹o:
- Äáº·t Action nÃ y sau vÃ²ng láº·p `rowItem` nhÆ°ng **váº«n náº±m trong Apply cá»§a tá»«ng column**  
- Äáº£m báº£o thá»© tá»± nhÆ° sau:
  ```
  For each column:
    â”œâ”€â”€ Set colName
    â”œâ”€â”€ Initialize currentBatch
    â”œâ”€â”€ Apply to each rowItem
    â”œâ”€â”€ Condition: length(currentBatch) > 0
        â”œâ”€â”€ YES â†’ Append to batches
  ```

---

Náº¿u báº¡n muá»‘n mÃ¬nh gá»­i **Flow máº«u `.zip`** hoáº·c **áº£nh sÆ¡ Ä‘á»“ trá»±c quan**, chá»‰ cáº§n nÃ³i nhÃ©!
