C·∫£m ∆°n b·∫°n ƒë√£ ph·∫£n h·ªìi! üõ†Ô∏è  
ƒê√∫ng r·ªìi, ph·∫ßn khai b√°o ki·ªÉu `[string, string[][]][]` s·∫Ω g√¢y l·ªói trong **Office Script**, v√¨ TypeScript trong m√¥i tr∆∞·ªùng Office Script **kh√¥ng h·ªó tr·ª£ tuple array khai b√°o ki·ªÉu ph·ª©c t·∫°p nh∆∞ v·∫≠y**.

---

## ‚úÖ C√°ch s·ª≠a ph√π h·ª£p v·ªõi Office Script

B·∫°n n√™n thay th·∫ø b·∫±ng khai b√°o **object** ƒë∆°n gi·∫£n h∆°n, v√≠ d·ª•:

```ts
type ColumnData = {
  columnName: string;
  values: string[][];
};
```

Sau ƒë√≥, ki·ªÉu d·ªØ li·ªáu s·∫Ω l√†:

```ts
ColumnData[]
```

---

## ‚úÖ C·∫≠p nh·∫≠t l·∫°i h√†m Office Script t∆∞∆°ng th√≠ch

### üîÅ **H√†m tr√≠ch xu·∫•t t·ª´ file ngu·ªìn (ƒë·ªçc d·ªØ li·ªáu)**

```ts
function main(workbook: ExcelScript.Workbook, columnNames: string[]): ColumnData[] {
  const sheet = workbook.getActiveWorksheet();
  const values = sheet.getUsedRange().getValues();

  const headers = values[0] as string[];
  let result: ColumnData[] = [];

  for (let name of columnNames) {
    const colIndex = headers.indexOf(name);
    if (colIndex === -1) continue;

    const columnValues = values.slice(1).map(row => [String(row[colIndex])]);
    result.push({
      columnName: name,
      values: columnValues
    });
  }

  return result;
}

type ColumnData = {
  columnName: string;
  values: string[][];
};
```

---

### üîÅ **H√†m ghi v√†o file ƒë√≠ch theo t√™n c·ªôt d√≤ng 2**

```ts
function main(workbook: ExcelScript.Workbook, inputData: ColumnData[]) {
  const sheet = workbook.getActiveWorksheet();
  const headerRow = 2;
  const startRow = 3;

  const headers = sheet.getRange(`A${headerRow}:Z${headerRow}`).getValues()[0] as string[];
  const colMap: Record<string, number> = {};

  headers.forEach((name, i) => {
    if (name) colMap[String(name).trim()] = i;
  });

  const rowCount = inputData[0].values.length;

  for (let i = 0; i < rowCount; i++) {
    for (let column of inputData) {
      const colIndex = colMap[column.columnName];
      if (colIndex !== undefined) {
        sheet.getCell(startRow - 1 + i, colIndex).setValue(column.values[i][0]);
      }
    }
  }
}

type ColumnData = {
  columnName: string;
  values: string[][];
};
```

---

### ‚úÖ ∆Øu ƒëi·ªÉm c√°ch d√πng `object`:

- D·ªÖ ƒë·ªçc, d·ªÖ m·ªü r·ªông (c√≥ th·ªÉ th√™m `dataType`, `format`, v.v. sau n√†y).
- D·ªÖ thao t√°c trong Power Automate.
- T∆∞∆°ng th√≠ch ho√†n to√†n v·ªõi Office Script.

---

B·∫°n mu·ªën m√¨nh gi√∫p th√™m ph·∫ßn **Parse JSON m·∫´u cho ki·ªÉu `ColumnData[]` n√†y** ƒë·ªÉ d√πng trong Power Automate kh√¥ng?


R·∫•t th·ª±c t·∫ø lu√¥n! Vi·ªác ki·ªÉm tra `getUsedRange()` c√≥ tr·∫£ v·ªÅ `null` hay kh√¥ng l√† **r·∫•t quan tr·ªçng** trong Office Script, v√¨ n·∫øu b·∫°n c·ªë g·ªçi `.getValues()` tr√™n `null` th√¨ script s·∫Ω l·ªói ngay.

---

## ‚úÖ C√°ch ki·ªÉm tra `getUsedRange()` c√≥ tr·∫£ v·ªÅ `null` hay kh√¥ng

### üî∏ C√°ch vi·∫øt an to√†n:

```ts
const usedRange = sheet.getUsedRange();

if (!usedRange) {
  console.log("Sheet kh√¥ng c√≥ d·ªØ li·ªáu!");
  return; // ho·∫∑c return [] n·∫øu ƒëang trong h√†m tr·∫£ d·ªØ li·ªáu
}
```

- `getUsedRange()` s·∫Ω **tr·∫£ v·ªÅ `undefined`** ho·∫∑c **`null`** n·∫øu **kh√¥ng c√≥ √¥ n√†o trong sheet ch·ª©a d·ªØ li·ªáu ho·∫∑c ƒë·ªãnh d·∫°ng.**
- D√π hi·∫øm g·∫∑p, v·∫´n n√™n ki·ªÉm tra ƒë·ªÉ tr√°nh l·ªói runtime.

---

### üî∏ C√°ch ƒë·∫ßy ƒë·ªß khi mu·ªën l·∫•y `values`:

```ts
const usedRange = sheet.getUsedRange();

if (!usedRange) {
  console.log("Kh√¥ng c√≥ v√πng d·ªØ li·ªáu ƒë∆∞·ª£c s·ª≠ d·ª•ng!");
  return [];
}

const values = usedRange.getValues();
```

---

## ‚úÖ Ho·∫∑c vi·∫øt g·ªçn b·∫±ng to√°n t·ª≠ `?`:

N·∫øu b·∫°n kh√¥ng ch·∫Øc `getUsedRange()` t·ªìn t·∫°i v√† mu·ªën vi·∫øt g·ªçn, b·∫°n c√≥ th·ªÉ d√πng to√°n t·ª≠ an to√†n (`?.`):

```ts
const values = sheet.getUsedRange()?.getValues() ?? [];
```

- `?.` s·∫Ω ki·ªÉm tra `getUsedRange()` c√≥ null kh√¥ng tr∆∞·ªõc khi g·ªçi `getValues()`.
- `?? []` ƒë·∫£m b·∫£o n·∫øu k·∫øt qu·∫£ l√† `undefined` th√¨ b·∫°n v·∫´n c√≥ gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† m·∫£ng r·ªóng.

---

## ‚úÖ M·ªôt g·ª£i √Ω kh√°c ‚Äì D·ª± ph√≤ng n·∫øu `getUsedRange()` kh√¥ng ƒë·ªß tin c·∫≠y

N·∫øu file b·∫°n x·ª≠ l√Ω ƒë√¥i khi c√≥ "v√πng tr·∫Øng" ho·∫∑c d·ªØ li·ªáu n·∫±m ngo√†i v√πng Excel coi l√† "used", b·∫°n c√≥ th·ªÉ x·ª≠ l√Ω th·ªß c√¥ng:

```ts
const values = sheet.getRange("A1:Z1000").getValues(); // gi·∫£ ƒë·ªãnh v√πng l·ªõn
```

Tuy nhi√™n, c√°ch n√†y c√≥ th·ªÉ l·∫•y c·∫£ nhi·ªÅu √¥ tr·ªëng kh√¥ng c·∫ßn thi·∫øt ‚Äì ph√π h·ª£p n·∫øu b·∫°n bi·∫øt ch·∫Øc v√πng d·ªØ li·ªáu n·∫±m trong ƒë√≥.

---

B·∫°n mu·ªën m√¨nh vi·∫øt cho b·∫°n m·ªôt **utility function `getSafeValues(sheet)`** ƒë·ªÉ d√πng l·∫°i nhi·ªÅu l·∫ßn kh√¥ng?


B·∫°n ƒëang n√≥i ƒë·∫øn ƒëo·∫°n:

```ts
const usedRange = sheet.getUsedRange();
```

v√† th·∫Øc m·∫Øc v·ªÅ gi·ªõi h·∫°n (limit) c·ªßa `getUsedRange()` ‚Äì c√≥ l·∫Ω b·∫°n ƒëang g·∫∑p ph·∫£i t√¨nh hu·ªëng:

- `getUsedRange()` kh√¥ng ho·∫°t ƒë·ªông nh∆∞ mong ƒë·ª£i.
- Ho·∫∑c b·∫°n nghi ng·ªù c√≥ gi·ªõi h·∫°n s·ªë √¥ ho·∫∑c s·ªë d√≤ng ƒë∆∞·ª£c tr·∫£ v·ªÅ.

---

## ‚úÖ Gi·∫£i th√≠ch v·ªÅ `getUsedRange()` v√† c√°c gi·ªõi h·∫°n

### üîπ `getUsedRange()` l√†m g√¨?
- Tr·∫£ v·ªÅ v√πng bao g·ªìm **t·∫•t c·∫£ c√°c √¥ c√≥ d·ªØ li·ªáu ho·∫∑c ƒë·ªãnh d·∫°ng**.
- T·ª± ƒë·ªông x√°c ƒë·ªãnh t·ª´ √¥ ƒë·∫ßu ti√™n ch·ª©a d·ªØ li·ªáu ƒë·∫øn √¥ cu·ªëi c√πng.
- **Kh√¥ng c·∫ßn ch·ªâ ƒë·ªãnh v√πng c·ª• th·ªÉ**, n√≥ qu√©t to√†n sheet.

---

### üîπ C√≥ gi·ªõi h·∫°n kh√¥ng?

| Thu·ªôc t√≠nh               | Gi·ªõi h·∫°n k·ªπ thu·∫≠t |
|--------------------------|------------------|
| T·ªïng s·ªë d√≤ng trong Excel | 1,048,576        |
| T·ªïng s·ªë c·ªôt              | 16,384 (c·ªôt XFD) |

> Tuy nhi√™n, `getUsedRange()` **ch·ªâ tr·∫£ v·ªÅ ƒë√∫ng ph·∫°m vi ƒëang c√≥ d·ªØ li·ªáu/thay ƒë·ªïi**, n√™n **hi·∫øm khi ƒë·ª•ng gi·ªõi h·∫°n** tr·ª´ khi b·∫°n x·ª≠ l√Ω file c·ª±c l·ªõn.

---

## ‚ùó C√°c t√¨nh hu·ªëng th·ª±c t·∫ø b·∫°n c√≥ th·ªÉ g·∫∑p:

### 1. `getUsedRange()` tr·∫£ v·ªÅ `null` ho·∫∑c l·ªói
- Sheet ho√†n to√†n tr·ªëng, ho·∫∑c b·∫°n v·ª´a x√≥a h·∫øt d·ªØ li·ªáu nh∆∞ng ch∆∞a l∆∞u file.
- C·∫ßn g·ªçi `getUsedRange()` sau khi ch·∫Øc ch·∫Øn sheet c√≥ d·ªØ li·ªáu.

### 2. B·∫°n ch·ªâ l·∫•y ƒë∆∞·ª£c m·ªôt ph·∫ßn d·ªØ li·ªáu (thi·∫øu d√≤ng/c·ªôt)
- C√≥ th·ªÉ c√≥ ƒë·ªãnh d·∫°ng r√°c trong sheet khi·∫øn `UsedRange` bao g·ªìm nhi·ªÅu √¥ tr·ªëng kh√¥ng ng·ªù t·ªõi.
- Ho·∫∑c d·ªØ li·ªáu n·∫±m ngo√†i v√πng b·∫°n nghƒ© (v√≠ d·ª•: ·ªü c·ªôt AZ hay d√≤ng 2000).

---

## ‚úÖ C√°ch ki·ªÉm tra ph·∫°m vi `UsedRange` ƒëang bao g·ªìm g√¨

B·∫°n c√≥ th·ªÉ log v·ªã tr√≠ h√†ng v√† c·ªôt:

```ts
const usedRange = sheet.getUsedRange();

if (!usedRange) {
  console.log("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë∆∞·ª£c s·ª≠ d·ª•ng.");
  return;
}

const rowCount = usedRange.getRowCount();
const columnCount = usedRange.getColumnCount();
const startRow = usedRange.getRowIndex();
const startColumn = usedRange.getColumnIndex();

console.log(`Used range b·∫Øt ƒë·∫ßu t·ª´ d√≤ng ${startRow + 1}, c·ªôt ${startColumn + 1}, k√≠ch th∆∞·ªõc ${rowCount} x ${columnCount}`);
```

> Excel s·ª≠ d·ª•ng **ch·ªâ s·ªë b·∫Øt ƒë·∫ßu t·ª´ 0**, n√™n c·∫ßn `+1` ƒë·ªÉ ra ƒë√∫ng s·ªë d√≤ng/c·ªôt theo m·∫Øt ng∆∞·ªùi.

---

## ‚úÖ N·∫øu b·∫°n mu·ªën "gi·ªõi h·∫°n v√πng d·ªØ li·ªáu" th·ªß c√¥ng

V√≠ d·ª•: b·∫°n ch·ªâ mu·ªën x·ª≠ l√Ω t·ª´ A1 ƒë·∫øn H1000:

```ts
const range = sheet.getRange("A1:H1000");
const values = range.getValues();
```

---

## B·∫°n mu·ªën g√¨ ti·∫øp theo?

- M√¨nh c√≥ th·ªÉ gi√∫p b·∫°n vi·∫øt m·ªôt **h√†m `getActualDataRange()`** ƒë·ªÉ t·ª± ƒë·ªông x√°c ƒë·ªãnh v√πng c√≥ d·ªØ li·ªáu th·ª±c (kh√¥ng b·ªã ·∫£nh h∆∞·ªüng b·ªüi ƒë·ªãnh d·∫°ng r√°c).
- Ho·∫∑c b·∫°n c√≥ th·ªÉ g·ª≠i c·ª• th·ªÉ **b·∫°n g·∫∑p l·ªói g√¨ khi d√πng `getUsedRange()`**, ƒë·ªÉ m√¨nh h·ªó tr·ª£ ƒë√∫ng ƒëi·ªÉm b·∫°n c·∫ßn.

C·∫ßn m√¨nh h·ªó tr·ª£ ph·∫ßn n√†o ti·∫øp theo?

Ho√†n to√†n ch√≠nh x√°c! N·∫øu:

- T√™n c·ªôt n·∫±m ·ªü **d√≤ng 1** (index 0 trong Office Script).
- B·∫°n **b·ªè qua d√≤ng 2** (c√≥ th·ªÉ l√† ghi ch√∫, m√¥ t·∫£...).
- D·ªØ li·ªáu b·∫Øt ƒë·∫ßu t·ª´ **d√≤ng 3** (index 2 tr·ªü ƒëi).

üëâ Th√¨ b·∫°n **ch·ªâ c·∫ßn x√°c ƒë·ªãnh d√≤ng cu·ªëi c√πng c√≥ d·ªØ li·ªáu**, r·ªìi l·∫•y d·ªØ li·ªáu t·ª´ d√≤ng 3 tr·ªü xu·ªëng l√† ƒë·ªß.

---

## ‚úÖ Code c·∫≠p nh·∫≠t ph√π h·ª£p y√™u c·∫ßu c·ªßa b·∫°n:

```ts
function main(workbook: ExcelScript.Workbook, columnNames: string[]): ColumnData[] {
  const sheet = workbook.getActiveWorksheet();
  const maxRows = 1000; // qu√©t tr∆∞·ªõc 1000 d√≤ng
  const maxCols = 30;   // v√† 30 c·ªôt

  // Qu√©t v√πng d·ªØ li·ªáu t·ª´ A1 ƒë·ªÉ x√°c ƒë·ªãnh headers v√† d√≤ng cu·ªëi
  const scanRange = sheet.getRangeByIndexes(0, 0, maxRows, maxCols);
  const allValues = scanRange.getValues();

  // D√≤ng ti√™u ƒë·ªÅ n·∫±m ·ªü d√≤ng 1 (index 0)
  const headers = allValues[0] as string[];

  // X√°c ƒë·ªãnh d√≤ng d·ªØ li·ªáu cu·ªëi c√πng (b·∫Øt ƒë·∫ßu t·ª´ d√≤ng 3 = index 2)
  let lastRow = 2;
  for (let i = allValues.length - 1; i >= 2; i--) {
    if (allValues[i].some(cell => cell !== "" && cell !== null)) {
      lastRow = i + 1;
      break;
    }
  }

  // Tr√≠ch d·ªØ li·ªáu th·ª±c t·∫ø t·ª´ d√≤ng 3 ƒë·∫øn d√≤ng cu·ªëi
  const dataRowCount = lastRow - 2;
  const dataRange = sheet.getRangeByIndexes(2, 0, dataRowCount, headers.length);
  const dataValues = dataRange.getValues();

  let result: ColumnData[] = [];

  for (let name of columnNames) {
    const colIndex = headers.indexOf(name);
    if (colIndex === -1) continue;

    const columnData = dataValues.map(row => [String(row[colIndex] ?? "")]);
    result.push({
      columnName: name,
      values: columnData
    });
  }

  return result;
}

// Ki·ªÉu d·ªØ li·ªáu tr·∫£ ra
type ColumnData = {
  columnName: string;
  values: string[][];
};
```

---

## üìå Gi·∫£i th√≠ch ƒëi·ªÉm ch√≠nh:

| D√≤ng | √ù nghƒ©a |
|------|--------|
| `headers = allValues[0]` | L·∫•y d√≤ng 1 l√†m ti√™u ƒë·ªÅ |
| `for (i = allValues.length - 1 ... i >= 2)` | T√¨m d√≤ng cu·ªëi t·ª´ d√≤ng 3 tr·ªü ƒëi |
| `sheet.getRangeByIndexes(2, 0, ...)` | Tr√≠ch d·ªØ li·ªáu t·ª´ d√≤ng 3 (index 2) |
| `values.map(row => [row[colIndex]])` | L·∫•y t·ª´ng c·ªôt theo t√™n |

---

## ‚úÖ K·∫øt qu·∫£ tr·∫£ ra:

```ts
[
  {
    columnName: "Ph√≤ng ban",
    values: [["K·∫ø to√°n"], ["K·ªπ thu·∫≠t"], ["H√†nh ch√≠nh"]]
  },
  {
    columnName: "T√™n",
    values: [["An"], ["B√¨nh"], ["Ch√¢u"]]
  }
]
```

---

N·∫øu b·∫°n mu·ªën ph·∫ßn n√†y tr·∫£ v·ªÅ ƒë·ªÉ x·ª≠ l√Ω ti·∫øp trong Power Automate, th√¨ ch·ªâ c·∫ßn d√πng **"Run script"** r·ªìi parse `outputs('Run_script')?['body']`.

C·∫ßn m√¨nh vi·∫øt lu√¥n ph·∫ßn Power Automate JSON m·∫´u kh√¥ng?
