DÆ°á»›i Ä‘Ã¢y lÃ  **hÆ°á»›ng dáº«n chi tiáº¿t tá»«ng bÆ°á»›c chia batch data trong Power Automate**, phÃ¹ há»£p vá»›i luá»“ng xá»­ lÃ½ cá»§a báº¡n khi dÃ¡n dá»¯ liá»‡u Excel báº±ng Office Script.

---

## âœ… Má»¤C TIÃŠU

Giáº£ sá»­ báº¡n cÃ³ dá»¯ liá»‡u dáº¡ng:

```json
{
  "columnName": "PhÃ²ng ban",
  "values": [["IT"], ["HR"], ["Finance"], ["Sales"], ["Admin"], ...]
}
```

Báº¡n muá»‘n:

- **Chia máº£ng `values` thÃ nh nhiá»u batch** (VD: má»—i batch 500 dÃ²ng)
- Gá»i `Run script` **nhiá»u láº§n**, má»—i láº§n chá»‰ gá»­i 1 batch nhá» â†’ trÃ¡nh `timeout` khi `setValues()`

---

## âœ… HÆ¯á»šNG DáºªN CHI TIáº¾T â€“ CHIA BATCH TRONG POWER AUTOMATE

### ğŸ”¹ **1. Parse JSON Ä‘áº§u vÃ o**
Sau bÆ°á»›c báº¡n nháº­n Ä‘Æ°á»£c data tá»« Office Script pháº§n "trÃ­ch xuáº¥t", dÃ¹ng **"Parse JSON"** Ä‘á»ƒ xá»­ lÃ½.

- Content: output tá»« bÆ°á»›c script
- Schema máº«u:
```json
{
  "type": "object",
  "properties": {
    "columnName": { "type": "string" },
    "values": {
      "type": "array",
      "items": {
        "type": "array",
        "items": { "type": "string" }
      }
    }
  }
}
```

---

### ğŸ”¹ **2. Táº¡o biáº¿n dÃ¹ng Ä‘á»ƒ chia batch**
ThÃªm bÆ°á»›c **Initialize variable**:

| TÃªn biáº¿n | Loáº¡i | GiÃ¡ trá»‹ ban Ä‘áº§u |
|----------|------|------------------|
| `batchSize` | Integer | 500 |
| `currentBatch` | Array | `[]` |
| `batches` | Array | `[]` |

---

### ğŸ”¹ **3. DÃ¹ng "Apply to each" Ä‘á»ƒ chia batch**
- **Apply to each** â†’ dÃ¹ng cho `body('Parse_JSON')?['values']`

**Trong má»—i vÃ²ng láº·p:**

1. **Append item vÃ o `currentBatch`**
   - Action: `Append to array variable`
   - Variable: `currentBatch`
   - Value: `items('Apply_to_each')`

2. **Check náº¿u currentBatch Ä‘á»§ batchSize**
   - Action: `Condition`
   - Condition:  
     ```
     length(variables('currentBatch')) is equal to variables('batchSize')
     ```

3. **Náº¿u ÄÃšNG (Ä‘á»§ batch):**
   - **Append currentBatch vÃ o batches**
     - `Append to array variable`
     - Name: `batches`
     - Value: `variables('currentBatch')`

   - **Reset currentBatch vá» []**
     - `Set variable`
     - Name: `currentBatch`
     - Value: `[]`

---

### ğŸ”¹ **4. Sau loop: Náº¿u cÃ²n batch cuá»‘i â†’ thÃªm vÃ o**
ThÃªm 1 bÆ°á»›c **"Condition"** bÃªn ngoÃ i `Apply to each`:

- **Condition**:
  ```
  length(variables('currentBatch')) > 0
  ```

- Náº¿u ÄÃšNG:
  - `Append to array variable` â†’ `batches` â† `variables('currentBatch')`

---

### ğŸ”¹ **5. Apply to each tá»«ng batch Ä‘á»ƒ gá»i Office Script**
- **Apply to each** â†’ `variables('batches')`

**BÃªn trong:**

1. **Run script**
   - Script: Office Script pháº§n dÃ¡n 1 cá»™t
   - Input JSON:
     ```json
     {
       "columnName": "<tÃªn cá»™t báº¡n Ä‘ang xá»­ lÃ½>",
       "values": @{items('Apply_to_each')}
     }
     ```

ğŸ‘‰ Báº¡n cÃ³ thá»ƒ dÃ¹ng expression:
```plaintext
{
  "columnName": body('Parse_JSON')?['columnName'],
  "values": items('Apply_to_each')
}
```

---

## âœ… HÃŒNH MINH Há»ŒA (náº¿u cáº§n)

MÃ¬nh cÃ³ thá»ƒ táº¡o cho báº¡n áº£nh minh há»a tá»«ng bÆ°á»›c, hoáº·c gá»­i `.zip` file Ä‘á»ƒ báº¡n import ngay Flow.

---

## ğŸ“Œ Máº¸O NÃ‚NG CAO

- Báº¡n cÃ³ thá»ƒ **cháº¡y song song cÃ¡c batch** báº±ng cÃ¡ch báº­t **Concurrency** trong `Apply to each`.
- Náº¿u xá»­ lÃ½ nhiá»u cá»™t â†’ gá»i Apply to each lá»“ng (theo tá»«ng cá»™t, tá»«ng batch).

---

Báº¡n muá»‘n mÃ¬nh gá»­i **file máº«u Power Automate `.zip`**, hoáº·c áº£nh chá»¥p chi tiáº¿t tá»«ng bÆ°á»›c khÃ´ng? MÃ¬nh cÃ³ thá»ƒ gá»­i ngay ğŸ‘‡
