DÆ°á»›i Ä‘Ã¢y lÃ  **hÆ°á»›ng dáº«n chi tiáº¿t tá»«ng bÆ°á»›c** Ä‘á»ƒ báº¡n thá»±c hiá»‡n quy trÃ¬nh:

---

## ğŸ¯ **Má»¤C TIÃŠU:**
DÃ¡n dá»¯ liá»‡u Excel **nhiá»u cá»™t, nhiá»u dÃ²ng (vÃ­ dá»¥: 90.000)** vÃ o file Ä‘Ã­ch, nhÆ°ng Ä‘á»ƒ **tá»‘i Æ°u hiá»‡u suáº¥t**, ta sáº½:

> ğŸ”¹ TÃ¡ch dá»¯ liá»‡u thÃ nh **tá»«ng cá»™t riÃªng biá»‡t**  
> ğŸ”¹ Sau Ä‘Ã³ chia **tá»«ng cá»™t thÃ nh nhiá»u batch nhá» (5.000 dÃ²ng)**  
> ğŸ”¹ VÃ  gá»i Office Script **nhiá»u láº§n**, má»—i láº§n dÃ¡n 1 batch / 1 cá»™t

---

## ğŸ› ï¸ **THá»°C HIá»†N CHI TIáº¾T**

---

### âœ… **PHáº¦N 1: TrÃ­ch xuáº¥t dá»¯ liá»‡u tá»« file Excel nguá»“n**

#### ğŸ“Œ Office Script 1 â€“ (DÃ¹ng `Run script` trong Power Automate):

```ts
function main(workbook: ExcelScript.Workbook, inputColumns: string[]): { columns: { columnName: string, values: string[][] }[] } {
  const sheet = workbook.getActiveWorksheet();

  const maxCols = 100;
  const header = sheet.getRangeByIndexes(0, 0, 1, maxCols).getValues()[0];

  let colMap: Record<string, number> = {};
  for (let i = 0; i < header.length; i++) {
    const name = header[i]?.toString().trim();
    if (name) colMap[name] = i;
  }

  const checkRange = sheet.getRange("A2:A100000").getValues();
  let lastRow = 1;
  for (let i = checkRange.length - 1; i >= 0; i--) {
    if (checkRange[i][0] !== "" && checkRange[i][0] !== null) {
      lastRow = i + 2;
      break;
    }
  }

  const columns: { columnName: string, values: string[][] }[] = [];
  for (const name of inputColumns) {
    const colIndex = colMap[name];
    if (colIndex === undefined) continue;
    const data = sheet.getRangeByIndexes(1, colIndex, lastRow - 1, 1).getValues();
    columns.push({ columnName: name, values: data as string[][] });
  }

  return { columns };
}
```

---

### âœ… **PHáº¦N 2: Flow Power Automate xá»­ lÃ½ tá»«ng cá»™t & chia batch**

#### ğŸªœ Step-by-step:

---

#### ğŸ”¹ **1. Trigger flow**
- VÃ­ dá»¥: khi user nháº¥n nÃºt (Manual Trigger), hoáº·c khi file má»›i Ä‘Æ°á»£c upload lÃªn OneDrive/SharePoint

---

#### ğŸ”¹ **2. Get file content (Excel nguá»“n)**

- Action: `Get file content using path`
- Output: `fileContentSource`

---

#### ğŸ”¹ **3. Run Script â€“ TrÃ­ch xuáº¥t dá»¯ liá»‡u tá»« Excel**

- Action: `Run script`
- Script: Office Script 1
- Input:
```json
["PhÃ²ng ban", "TÃªn"]
```

---

#### ğŸ”¹ **4. Parse JSON Ä‘á»ƒ tÃ¡ch cá»™t**
- Schema:
```json
{
  "type": "object",
  "properties": {
    "columns": {
      "type": "array",
      "items": {
        "type": "object",
        "properties": {
          "columnName": { "type": "string" },
          "values": {
            "type": "array",
            "items": {
              "type": "array",
              "items": { "type": "string" }
            }
          }
        },
        "required": ["columnName", "values"]
      }
    }
  }
}
```

---

#### ğŸ”¹ **5. Apply to each â†’ Vá»›i má»—i column**

- `from`: `body('Run_script')?['columns']`

##### BÃªn trong vÃ²ng láº·p:

---

#### ğŸ”¸ **5.1. GÃ¡n biáº¿n `columnName` vÃ  `allValues`**

- columnName: `item()?['columnName']`  
- allValues: `item()?['values']`

---

#### ğŸ”¸ **5.2. CHIA BATCH â€“ Táº¡o array chá»©a tá»«ng batch 5000 dÃ²ng**

- Action: **Compose â€“ Chunked Values**
- Expression: *(Giáº£ sá»­ báº¡n dÃ¹ng inline code Ä‘á»ƒ chia)*

```plaintext
chunk(variables('allValues'), 5000)
```

**ğŸ“Œ Gá»£i Ã½**: Náº¿u Power Automate khÃ´ng há»— trá»£ `chunk()`, cÃ³ thá»ƒ dÃ¹ng Power Automate Desktop hoáº·c sá»­ dá»¥ng flow phá»¥ chia thá»§ cÃ´ng.

---

#### ğŸ”¸ **5.3. Apply to each â†’ Má»—i batch**

- `from`: output cá»§a bÆ°á»›c chunk á»Ÿ trÃªn

---

##### Trong vÃ²ng láº·p batch:

#### ğŸ”¹ **Gá»i `Run script` â€“ DÃ¡n batch vÃ o Excel Ä‘Ã­ch**

- Office Script: PHáº¦N 3 bÃªn dÆ°á»›i
- Input script:
```json
{
  "columnName": "@{variables('columnName')}",
  "values": @{items('Apply_to_each_batch')}
}
```

---

### âœ… **PHáº¦N 3: Office Script dÃ¡n dá»¯ liá»‡u 1 batch / 1 cá»™t**

```ts
function main(workbook: ExcelScript.Workbook, input: { columnName: string, values: string[][] }): void {
  const sheet = workbook.getActiveWorksheet();

  const maxCols = 100;
  const headerRow = sheet.getRangeByIndexes(1, 0, 1, maxCols).getValues()[0];

  let colMap: Record<string, number> = {};
  for (let i = 0; i < headerRow.length; i++) {
    const name = headerRow[i]?.toString().trim();
    if (name) colMap[name] = i;
  }

  const colIndex = colMap[input.columnName];
  if (colIndex === undefined) return;

  const checkRange = sheet.getRangeByIndexes(2, colIndex, 100000, 1).getValues();
  let lastRow = 2;
  for (let i = checkRange.length - 1; i >= 0; i--) {
    if (checkRange[i][0] !== null && checkRange[i][0] !== "") {
      lastRow = i + 3;
      break;
    }
  }

  const rowCount = input.values.length;
  const targetRange = sheet.getRangeByIndexes(lastRow, colIndex, rowCount, 1);
  targetRange.setValues(input.values);
}
```

---

## ğŸš€ Æ¯U ÄIá»‚M Cá»¦A GIáº¢I PHÃP

| TÃ­nh nÄƒng                   | CÃ³ |
|----------------------------|----|
| Chia nhá» batch khi dÃ¡n     | âœ… |
| DÃ¡n tá»«ng cá»™t riÃªng biá»‡t    | âœ… |
| TrÃ¡nh timeout hoáº·c quÃ¡ táº£i | âœ… |
| CÃ³ thá»ƒ retry náº¿u lá»—i tá»«ng batch | âœ… |
| Tá»‘i Æ°u hiá»‡u nÄƒng cho 90k+ dÃ²ng | âœ… |

---

## ğŸ“¦ Muá»‘n nhanh hÆ¡n?
ğŸ‘‰ MÃ¬nh cÃ³ thá»ƒ táº¡o cho báº¡n:
- File `.zip` Flow Power Automate máº«u sáºµn
- Custom connector giÃºp chia batch náº¿u cáº§n
- Auto detect sá»‘ dÃ²ng, chia theo dynamic size

Cá»© nháº¯n nhÃ©! MÃ¬nh sáº½ gá»­i file hoáº·c há»— trá»£ thÃªm ngay.
