Hi ‚Äî r√µ v·∫•n ƒë·ªÅ r·ªìi: b·∫°n ƒëang ch·∫°y macro song song (Parallel) v·ªõi thao t√°c UI ƒë·ªÉ ƒëi·ªÅn path v√†o h·ªôp Save/Save As m√† macro t·ª± m·ªü ‚Äî k·∫øt qu·∫£ l√† sau khi b·∫°n nh·∫•n OK, macro b·ªã ‚Äúgi·∫≠t‚Äù ra kh·ªèi lu·ªìng th·ª±c thi (modal dialog b·ªã can thi·ªáp/race) v√† ph√°t sinh l·ªói (m·ªôt m√£ l·ªói n·ªôi b·ªô ki·ªÉu 9C86 do tr·∫°ng th√°i Excel/COM kh√¥ng mong ƒë·ª£i). Gi·∫£i ph√°p l√† kh√¥ng ƒë·ªÉ UI automation v√† macro tranh nhau control c·ªßa Excel ‚Äî m√¨nh li·ªát k√™ c√°c c√°ch s·ª≠a, theo th·ª© t·ª± t·ª´ t·ªët nh·∫•t / an to√†n nh·∫•t ƒë·∫øn t·∫°m ch·∫•p nh·∫≠n:

1) (T·ªët nh·∫•t) Kh√¥ng m·ªü dialog ‚Äî truy·ªÅn path cho macro r·ªìi l∆∞u t·ª´ trong macro

N·∫øu c√≥ th·ªÉ s·ª≠a macro, th√™m tham s·ªë path v√† cho macro t·ª± save m√† kh√¥ng c·∫ßn popup. V√≠ d·ª• VBA:

' Trong module VBA (ThisWorkbook ho·∫∑c Module1)
Public Sub MyMacroAndSave(Optional ByVal savePath As String = "")
    On Error GoTo ErrHandler

    ' --- c√°c c√¥ng vi·ªác macro c·ªßa b·∫°n ---
    ' ... (x·ª≠ l√Ω, export, t·∫°o file CSV, ...)
    ' -----------------------------------

    If Len(Trim(savePath)) > 0 Then
        Application.DisplayAlerts = False
        ThisWorkbook.SaveAs Filename:=savePath, FileFormat:=xlCSV
        Application.DisplayAlerts = True
    Else
        ' N·∫øu kh√¥ng c√≥ path, c√≥ th·ªÉ v·∫´n show dialog (ch·ªâ n·∫øu c·∫ßn)
        Application.Dialogs(xlDialogSaveAs).Show
    End If

    Exit Sub
ErrHandler:
    Application.DisplayAlerts = True
    MsgBox "L·ªói trong macro: " & Err.Number & " - " & Err.Description
End Sub

Trong UiPath (ho·∫∑c automation c·ªßa b·∫°n) ‚Äî g·ªçi macro n√†y v·ªõi tham s·ªë ƒë∆∞·ªùng d·∫´n thay v√¨ ƒë·ªÉ macro m·ªü SaveAs:

D√πng Excel Application Scope + Invoke VBA (ho·∫∑c Execute Macro v·ªõi approach t∆∞∆°ng ƒë∆∞∆°ng) ƒë·ªÉ g·ªçi MyMacroAndSave v√† truy·ªÅn ƒë∆∞·ªùng d·∫´n file.

V√¨ macro t·ª± l∆∞u, kh√¥ng c·∫ßn thao t√°c UI => kh√¥ng c√≤n race.


2) N·∫øu kh√¥ng s·ª≠a ƒë∆∞·ª£c macro: ch·∫°y macro ƒë·ªìng b·ªô (kh√¥ng d√πng Parallel) v√† automa h√≥a dialog sau khi macro ƒë√£ m·ªü ‚Äî ƒë·∫£m b·∫£o ch·ªù dialog s·∫µn s√†ng

Nguy√™n t·∫Øc: kh√¥ng ch·∫°y song song. Trong UiPath (ho·∫∑c c√¥ng c·ª• t∆∞∆°ng t·ª±) l√†m theo:

1. Sequence (kh√¥ng Parallel).


2. Trigger macro (Activity: Execute Macro / Invoke VBA / G·ªçi COM Application.Run("MacroName")) ‚Äî ƒë·ª£i macro tr·∫£ v·ªÅ control (Activity n√†y th∆∞·ªùng ch·∫∑n cho ƒë·∫øn khi macro k·∫øt th√∫c, nh∆∞ng n·∫øu macro t·∫°o dialog modal th√¨ control s·∫Ω n·∫±m trong Excel v√† activity c√≥ th·ªÉ tr·∫£ v·ªÅ s·ªõm; v√¨ v·∫≠y c·∫ßn ch·ªù dialog).


3. D√πng Element Exists / On Element Appear ho·∫∑c Find Window v·ªõi selector c·ªßa SaveAs dialog (title th∆∞·ªùng l√† ‚ÄúSave As‚Äù ho·∫∑c ‚ÄúFile name‚Äù field) ‚Äî loop ch·ªù t·ªõi khi dialog xu·∫•t hi·ªán.


4. Attach Window v√†o SaveAs dialog ‚Üí Type Into v√†o field File name tr∆∞·ªùng h·ª£p c·∫ßn, ho·∫∑c Set Text n·∫øu c√≥.

Kh√¥ng d√πng SimulateType n·∫øu dialog modal/Native ‚Äî th·ª≠ b·∫≠t/ t·∫Øt SendWindowMessages ho·∫∑c ch·ªçn ClickBeforeTyping.



5. Send Hotkey Enter ho·∫∑c click OK button trong dialog.


6. Ch·ªù macro ti·∫øp t·ª•c v√† k·∫øt th√∫c ‚Äî On Element Vanish ho·∫∑c Element Exists ƒë·ªÉ ki·ªÉm tra macro ƒë√£ ho√†n t·∫•t.



G·ª£i √Ω selector/chi ti·∫øt:

Element Exists ki·ªÉm tra textbox v·ªõi aaname='File name:' hay title c·ª≠a s·ªï.

N·∫øu g·∫∑p difficulty v·ªõi selectors, d√πng SendHotkey + tab ƒë·ªÉ di chuy·ªÉn t·ªõi File name r·ªìi Type Into.


3) N·∫øu v·∫´n c·∫ßn ch·∫°y song song (kh√¥ng khuy·∫øn ngh·ªã) ‚Äî c·ª±c k·ª≥ d·ªÖ l·ªói

N·∫øu b·∫°n b·∫Øt bu·ªôc ph·∫£i d√πng Parallel, c·∫ßn ƒë·∫£m b·∫£o lock/ mutex ƒë·ªÉ ch·ªâ 1 lu·ªìng thao t√°c UI v·ªõi Excel t·∫°i m·ªôt l√∫c. Nh∆∞ng modal dialog Excel r·∫•t d·ªÖ g√¢y deadlock v√† race; m√¨nh KH√îNG khuy·∫øn ngh·ªã.


4) Tinh ch·ªânh macro ƒë·ªÉ tr√°nh l·ªói khi dialog b·ªã ƒë√≥ng

N·∫øu kh√¥ng th·ªÉ thay ƒë·ªïi c√°ch m·ªü dialog, √≠t nh·∫•t th√™m error handling trong macro ƒë·ªÉ nh·∫≠n di·ªán khi dialog b·ªã thao t√°c t·ª´ ngo√†i:

Sub MyMacro()
    On Error GoTo ErrHandler
    ' ... x·ª≠ l√Ω ...
    Application.EnableEvents = False
    ' m·ªü dialog
    Application.Dialogs(xlDialogSaveAs).Show
    Application.EnableEvents = True
    Exit Sub
ErrHandler:
    Application.EnableEvents = True
    MsgBox "Macro b·ªã l·ªói: " & Err.Number & " - " & Err.Description
End Sub

Nguy√™n nh√¢n c·ª• th·ªÉ c·ªßa  l·ªói 9C86

M√£ 9C86 tr√¥ng nh∆∞ m√£ n·ªôi b·ªô/ƒë·ªãnh d·∫°ng tool (kh√¥ng ph·∫£i Err.Number ti√™u chu·∫©n 0..65535). Th∆∞·ªùng l√† do:

Macro b·ªã interrupt b·ªüi UI automation ‚Üí Excel COM tr·∫£ v·ªÅ tr·∫°ng th√°i kh√¥ng h·ª£p l·ªá.

Dialog b·ªã focus/close t·ª´ automation tr∆∞·ªõc khi macro k·ªãp ti·∫øp t·ª•c ‚Üí macro nh·∫≠n exception.

Nhi·ªÅu process/instance Excel c√πng tranh control (v√≠ d·ª• ch·∫°y hai Excel instance).


Checklist kh·∫Øc ph·ª•c nhanh b·∫°n c√≥ th·ªÉ l√†m ngay

‚õî B·ªè Parallel ‚Äî chuy·ªÉn th√†nh Sequence.

‚úÖ S·ª≠a macro cho nh·∫≠n path (n·∫øu ƒë∆∞·ª£c) v√† d√πng ThisWorkbook.SaveAs trong macro.

‚úÖ Ho·∫∑c: ch·ªù dialog xu·∫•t hi·ªán (Element Exists), Attach Window r·ªìi Type Into + Enter.

‚úÖ B·∫≠t Application.DisplayAlerts = False trong macro n·∫øu mu·ªën tr√°nh dialog confirm.

‚úÖ Th√™m error handler trong macro ƒë·ªÉ log l·ªói (v√¨ th√¥ng b√°o UI th∆∞·ªùng b·ªã m·∫•t khi ch·∫°y t·ª´ automation).

üîé Ki·ªÉm tra xem c√≥ nhi·ªÅu instance Excel ch·∫°y hay kh√¥ng (Task Manager) ‚Äî ch·ªâ d√πng 1 instance.



---

N·∫øu b·∫°n mu·ªën m√¨nh vi·∫øt ƒëo·∫°n VBA ho√†n ch·ªânh (nh·∫≠n path => th·ª±c hi·ªán export + save) ho·∫∑c m√¥ t·∫£ chi ti·∫øt workflow UiPath (danh s√°ch activities, selectors m·∫´u, h√¨nh ·∫£nh minh h·ªça), m√¨nh s·∫Ω so·∫°n lu√¥n s·∫µn cho b·∫°n. B·∫°n mu·ªën: (A) code VBA ƒë·ªÉ macro t·ª± save, hay (B) h∆∞·ªõng d·∫´n UiPath step-by-step ƒë·ªÉ t·ª± fill dialog? Ch·ªçn 1 m√¨nh g·ª≠i lu√¥n m√£/flow.
