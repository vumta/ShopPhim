Váº¥n Ä‘á» báº¡n gáº·p pháº£i lÃ  ráº¥t phá»• biáº¿n: khi sá»­ dá»¥ng `Send an HTTP request to SharePoint` vá»›i `GetFolderByServerRelativeUrl('<path>')`, náº¿u Ä‘Æ°á»ng dáº«n chá»©a kÃ½ tá»± Ä‘áº·c biá»‡t (nhÆ° tiáº¿ng Nháº­t, dáº¥u cÃ¡ch, kÃ½ tá»± unicode, v.v.), **Power Automate sáº½ tá»± Ä‘á»™ng mÃ£ hÃ³a Ä‘Æ°á»ng dáº«n (URL encode)** â†’ vÃ  SharePoint cÃ³ thá»ƒ **khÃ´ng hiá»ƒu chÃ­nh xÃ¡c** Ä‘Æ°á»ng dáº«n Ä‘Ã³ ná»¯a â†’ dáº«n tá»›i lá»—i **"File not found"** hoáº·c **"The resource cannot be found."**

---

## âœ… Giáº£i phÃ¡p: **Tá»± encode Ä‘Ãºng cÃ¡ch vÃ  truyá»n vÃ o API chuáº©n**

---

### ğŸ§© Váº¥n Ä‘á»:
- ÄÆ°á»ng dáº«n nhÆ°:
  ```
  /Shared Documents/æ—¥æœ¬èª/ãƒ¬ãƒãƒ¼ãƒˆ 2024
  ```
  sáº½ bá»‹ Power Automate mÃ£ hÃ³a thÃ nh:
  ```
  /Shared%20Documents/%E6%97%A5%E6%9C%AC%E8%AA%9E/%E3%83%AC%E3%83%9D%E3%83%BC%E3%83%88%202024
  ```
  nhÆ°ng SharePoint cáº§n báº¡n xá»­ lÃ½ encode Ä‘Ãºng cÃ¡ch â€” nháº¥t lÃ  vá»›i hÃ m nhÆ° `GetFolderByServerRelativeUrl()`.

---

## âœ… Giáº£i phÃ¡p 1: DÃ¹ng **uriComponent()** Ä‘á»ƒ encode chÃ­nh xÃ¡c tá»«ng pháº§n

### ğŸ‘‰ CÃ¡ch lÃ m:

Thay vÃ¬ truyá»n nguyÃªn chuá»—i dÃ i vÃ o, báº¡n nÃªn encode báº±ng tay báº±ng cÃ¡ch:

### ğŸ”¹ BÆ°á»›c 1: Encode tá»«ng pháº§n Ä‘Æ°á»ng dáº«n
```plaintext
concat(
  '/_api/web/GetFolderByServerRelativeUrl(''',
  uriComponent('Shared Documents/æ—¥æœ¬èª/ãƒ¬ãƒãƒ¼ãƒˆ 2024'),
  ''')?$expand=Folders,Files'
)
```

> ğŸ§  `uriComponent()` sáº½ giÃºp encode Ä‘Ãºng theo chuáº©n URI SharePoint cáº§n.

---

### ğŸ”¹ BÆ°á»›c 2: DÃ¹ng biá»ƒu thá»©c trÃªn trong field "Uri" cá»§a `Send an HTTP request to SharePoint`

- HTTP method: `GET`
- Uri: dÃ¹ng biá»ƒu thá»©c trÃªn (báº¥m vÃ o **fx** Ä‘á»ƒ viáº¿t cÃ´ng thá»©c)
- Headers: thÃªm náº¿u cáº§n:
  ```json
  {
    "Accept": "application/json;odata=verbose"
  }
  ```

---

## âœ… Giáº£i phÃ¡p 2: TÃ¡ch tá»«ng pháº§n rá»“i encode

Náº¿u báº¡n cÃ³ Ä‘Æ°á»ng dáº«n nhÆ° biáº¿n:  
`/Shared Documents/æ—¥æœ¬èª/ãƒ¬ãƒãƒ¼ãƒˆ 2024`

### Báº¡n cÃ³ thá»ƒ:

1. DÃ¹ng `split()` Ä‘á»ƒ chia cÃ¡c pháº§n theo `/`
2. Encode tá»«ng pháº§n báº±ng `uriComponent()`
3. Ná»‘i láº¡i báº±ng `%2F`

ğŸ”§ Biá»ƒu thá»©c máº«u:
```plaintext
concat(
  '/_api/web/GetFolderByServerRelativeUrl(''',
  join(apply(uriComponent, skip(split(variables('InputPath'), '/'), 1)), '%2F'),
  ''')?$expand=Folders,Files'
)
```

ğŸ“Œ Ghi chÃº:
- `skip(..., 1)` Ä‘á»ƒ loáº¡i bá» dáº¥u `/` á»Ÿ Ä‘áº§u.
- `apply(uriComponent, ...)` dÃ¹ng Ä‘á»ƒ encode tá»«ng pháº§n.
- `join(..., '%2F')` thay vÃ¬ `/` Ä‘á»ƒ trÃ¡nh bá»‹ lá»—i khi ghÃ©p láº¡i.

---

## âœ… Náº¿u váº«n lá»—i: hÃ£y kiá»ƒm tra thÃªm

- **KhÃ´ng dÃ¹ng dáº¥u `'` Ä‘Æ¡n hoáº·c `" "` thá»«a trong URL**
- Äáº£m báº£o URL khÃ´ng chá»©a **space hoáº·c `#`, `?` mÃ  chÆ°a Ä‘Æ°á»£c encode**
- Test URL encode á»Ÿ ngoÃ i (VD: [https://www.urlencoder.io/](https://www.urlencoder.io/)) Ä‘á»ƒ Ä‘á»‘i chiáº¿u

---

Náº¿u báº¡n chia sáº» chuá»—i URL cá»¥ thá»ƒ báº¡n Ä‘ang dÃ¹ng (gá»“m cÃ¡c thÆ° má»¥c cÃ³ tiáº¿ng Nháº­t), mÃ¬nh cÃ³ thá»ƒ viáº¿t sáºµn biá»ƒu thá»©c hoÃ n chá»‰nh Ä‘á»ƒ báº¡n copy vÃ o Power Automate nhÃ©!
====
Äá»ƒ **remove dáº¥u `/` á»Ÿ Ä‘áº§u chuá»—i Ä‘Æ°á»ng dáº«n** trong Power Automate, báº¡n cÃ³ thá»ƒ dÃ¹ng biá»ƒu thá»©c sau trong action `Set variable` hoáº·c `Compose`:

---

### âœ… **Biá»ƒu thá»©c loáº¡i bá» dáº¥u `/` á»Ÿ Ä‘áº§u chuá»—i (náº¿u cÃ³):**

```plaintext
if(startsWith(variables('InputPath'), '/'), substring(variables('InputPath'), 1), variables('InputPath'))
```

---

### ğŸ§  Giáº£i thÃ­ch:

| ThÃ nh pháº§n | Ã nghÄ©a |
|------------|--------|
| `startsWith(..., '/')` | Kiá»ƒm tra náº¿u chuá»—i báº¯t Ä‘áº§u báº±ng dáº¥u `/` |
| `substring(..., 1)` | Cáº¯t bá» kÃ½ tá»± Ä‘áº§u tiÃªn (báº¯t Ä‘áº§u tá»« index 1) |
| `if(...)` | Náº¿u cÃ³ dáº¥u `/` thÃ¬ bá», cÃ²n khÃ´ng thÃ¬ giá»¯ nguyÃªn |

---

### ğŸ“Œ VÃ­ dá»¥:

| `InputPath` (giÃ¡ trá»‹ gá»‘c)         | Káº¿t quáº£ sau xá»­ lÃ½                    |
|-----------------------------------|--------------------------------------|
| `/Shared Documents/Reports`      | `Shared Documents/Reports`          |
| `Shared Documents/Reports`       | `Shared Documents/Reports` *(khÃ´ng Ä‘á»•i)* |

---

### âœ… Náº¿u dÃ¹ng trong Compose:

```plaintext
if(startsWith(outputs('Compose_InputPath'), '/'), substring(outputs('Compose_InputPath'), 1), outputs('Compose_InputPath'))
```

---

Cáº§n mÃ¬nh há»— trá»£ Ä‘Æ°a vÃ o flow cá»¥ thá»ƒ nÃ o báº¡n Ä‘ang dÃ¹ng cÅ©ng Ä‘Æ°á»£c nhÃ©!
===================
Cáº£m Æ¡n báº¡n Ä‘Ã£ chia sáº» chi tiáº¿t â€“ mÃ¬nh hiá»ƒu váº¥n Ä‘á» báº¡n gáº·p pháº£i: **khi truy cáº­p `Files` hoáº·c `Folders` tá»« káº¿t quáº£ tráº£ vá» cá»§a `Send an HTTP request to SharePoint`, giÃ¡ trá»‹ luÃ´n bá»‹ `null` trong action `Condition` hoáº·c vÃ²ng láº·p**, dÃ¹ báº¡n cháº¯c cháº¯n API tráº£ vá» Ä‘Ãºng.

---

## ğŸ¯ Váº¥n Ä‘á» thá»±c sá»± lÃ  gÃ¬?

SharePoint REST API khi gá»i qua `Send an HTTP request to SharePoint` **khÃ´ng tá»± Ä‘á»™ng tráº£ vá» cáº¥u trÃºc JSON gá»n gÃ ng nhÆ° `Files` hoáº·c `Folders` mÃ  báº¡n cÃ³ thá»ƒ truy cáº­p trá»±c tiáº¿p**. Thay vÃ o Ä‘Ã³, **dá»¯ liá»‡u thÆ°á»ng náº±m trong pháº§n `d/results`**, hoáº·c báº¡n cáº§n `Parse JSON` Ä‘á»ƒ tÃ¡ch chÃ­nh xÃ¡c.

---

## âœ… Giáº£i phÃ¡p tá»«ng bÆ°á»›c Ä‘á»ƒ truy cáº­p `Files` / `Folders` chÃ­nh xÃ¡c:

---

### ğŸ”¹ **BÆ°á»›c 1: Gá»i API Ä‘Ãºng**

```http
/_api/web/GetFolderByServerRelativeUrl('/sites/TestSite/Shared Documents/Reports')?$expand=Folders,Files
```

---

### ğŸ”¹ **BÆ°á»›c 2: ThÃªm action `Parse JSON` Ä‘á»ƒ tÃ¡ch dá»¯ liá»‡u chuáº©n**

1. **Action**: `Parse JSON`
2. **Content**: Body cá»§a káº¿t quáº£ HTTP tráº£ vá».
3. **Schema**: Náº¿u khÃ´ng cháº¯c schema, báº¡n cÃ³ thá»ƒ:
   - Cháº¡y flow 1 láº§n.
   - Copy output máº«u cá»§a `Send an HTTP request to SharePoint`.
   - DÃ¡n vÃ o â€œGenerate from sampleâ€ trong Parse JSON Ä‘á»ƒ táº¡o schema.

> âš ï¸ Quan trá»ng: Schema pháº£i chá»©a cÃ¡c máº£ng `Files` vÃ  `Folders`.

---

### ğŸ”¹ **BÆ°á»›c 3: Truy cáº­p `Files` / `Folders` má»™t cÃ¡ch an toÃ n**

Giáº£ sá»­ báº¡n Ä‘Ã£ parse Ä‘Æ°á»£c JSON rá»“i, thÃ¬:

- Äá»ƒ duyá»‡t `Files`: dÃ¹ng `coalesce(body('Parse_JSON')?['Files'], [])`
- Äá»ƒ duyá»‡t `Folders`: dÃ¹ng `coalesce(body('Parse_JSON')?['Folders'], [])`

### âœ… Giáº£i thÃ­ch:

| HÃ m | Ã nghÄ©a |
|-----|--------|
| `coalesce(x, [])` | Náº¿u `x` lÃ  `null`, sáº½ thay tháº¿ báº±ng máº£ng rá»—ng `[]`, trÃ¡nh lá»—i |

---

### ğŸ”¹ **BÆ°á»›c 4: VÃ­ dá»¥ Ä‘iá»u kiá»‡n kiá»ƒm tra tÃªn file (trong Apply to each Files)**

Giáº£ sá»­ báº¡n Ä‘ang trong vÃ²ng láº·p `Apply to each` cho `Files`:

```plaintext
item()?['Name'] ends with '.pdf'
```

Hoáº·c kiá»ƒm tra path:

```plaintext
item()?['ServerRelativeUrl']
```

---

### ğŸ§ª Náº¿u báº¡n váº«n gáº·p lá»—i: HÃ£y debug báº±ng `Compose`

ThÃªm action `Compose` vÃ  set content lÃ :

```plaintext
body('Send_an_HTTP_request_to_SharePoint')
```

Kiá»ƒm tra xem `Files` vÃ  `Folders` náº±m á»Ÿ Ä‘Ã¢u? CÃ³ thá»ƒ chÃºng náº±m lá»“ng sÃ¢u nhÆ°:

```json
{
  "d": {
    "Files": { "results": [...] },
    "Folders": { "results": [...] }
  }
}
```

Khi Ä‘Ã³, báº¡n cáº§n truy cáº­p:

```plaintext
body('Send_an_HTTP_request_to_SharePoint')?['d']?['Files']?['results']
```

---

## âœ… Tá»•ng káº¿t cÃ¡ch lÃ m chuáº©n:

| BÆ°á»›c | HÃ nh Ä‘á»™ng |
|------|-----------|
| 1    | Gá»i Ä‘Ãºng API `/GetFolderByServerRelativeUrl(...)?$expand=Folders,Files` |
| 2    | DÃ¹ng `Parse JSON` hoáº·c truy cáº­p `body()?['d']?['Files']?['results']` náº¿u dá»¯ liá»‡u bá»‹ lá»“ng |
| 3    | DÃ¹ng `coalesce()` Ä‘á»ƒ xá»­ lÃ½ null |
| 4    | Truy cáº­p tá»«ng item trong vÃ²ng láº·p qua `item()?['Name']`, `item()?['ServerRelativeUrl']` |

---

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ giÃºp báº¡n **xÃ¢y sáºµn 1 máº«u flow JSON máº«u + Ä‘iá»u kiá»‡n kiá»ƒm tra file** Ä‘á»ƒ báº¡n paste vÃ o nhanh. Báº¡n cÃ³ dÃ¹ng action `"Send an HTTP request to SharePoint"` theo chuáº©n v2 khÃ´ng? VÃ  báº¡n Ä‘ang gáº·p lá»—i cá»¥ thá»ƒ trong action nÃ o?
===============
HoÃ n toÃ n Ä‘Æ°á»£c! Náº¿u báº¡n muá»‘n **kiá»ƒm tra ngay sau `Parse JSON`** xem pháº§n `Files` hoáº·c `Folders` cÃ³ pháº£i lÃ  `null` hay khÃ´ng, mÃ¬nh sáº½ hÆ°á»›ng dáº«n chi tiáº¿t theo cÃ¡ch dÃ¹ng `Condition` trong Power Automate chuáº©n nháº¥t.

---

## âœ… Má»¥c tiÃªu:  
Kiá»ƒm tra xem `Files` hoáº·c `Folders` **cÃ³ tá»“n táº¡i khÃ´ng**, sau `Parse JSON`.

---

## ğŸ”§ **CÃ¡ch lÃ m:**

### â¤ Giáº£ sá»­ báº¡n cÃ³ má»™t action `Parse JSON` tÃªn lÃ  `Parse_JSON`.

---

### âœ… **BÆ°á»›c 1: ThÃªm Action "Condition"**

**Kiá»ƒm tra `Files` cÃ³ khÃ¡c null khÃ´ng:**

**Condition:**
```plaintext
not(equals(variables('ParsedFiles'), null))
```

NhÆ°ng náº¿u báº¡n **khÃ´ng dÃ¹ng biáº¿n**, thÃ¬ hÃ£y dÃ¹ng trá»±c tiáº¿p:

```plaintext
not(equals(body('Parse_JSON')?['Files'], null))
```

TÆ°Æ¡ng tá»± cho `Folders`:

```plaintext
not(equals(body('Parse_JSON')?['Folders'], null))
```

---

### âœ… **BÆ°á»›c 2: Náº¿u báº¡n muá»‘n kiá»ƒm tra rá»—ng hoáº·c null luÃ´n:**

```plaintext
length(coalesce(body('Parse_JSON')?['Files'], [])) > 0
```

CÃ¡ch nÃ y Ä‘áº£m báº£o:
- Náº¿u `Files` lÃ  `null` â†’ biáº¿n thÃ nh `[]` â†’ `length = 0`
- Náº¿u cÃ³ file nÃ o â†’ `length > 0`

---

## ğŸ“Œ **TÃ³m táº¯t cÃ¡c cÃ´ng thá»©c**

| Má»¥c tiÃªu                            | Biá»ƒu thá»©c dÃ¹ng trong Condition                          |
|-------------------------------------|----------------------------------------------------------|
| Kiá»ƒm tra `Files` cÃ³ khÃ¡c `null`     | `not(equals(body('Parse_JSON')?['Files'], null))`       |
| Kiá»ƒm tra `Files` cÃ³ Ã­t nháº¥t 1 item  | `length(coalesce(body('Parse_JSON')?['Files'], [])) > 0`|
| Kiá»ƒm tra `Folders` lÃ  null          | `equals(body('Parse_JSON')?['Folders'], null)`          |
| Kiá»ƒm tra `Folders` khÃ´ng rá»—ng       | `length(coalesce(body('Parse_JSON')?['Folders'], [])) > 0` |

---

## ğŸ“Œ Gá»£i Ã½ debug:
Náº¿u khÃ´ng cháº¯c dá»¯ liá»‡u cÃ³ Ä‘Ãºng khÃ´ng, báº¡n cÃ³ thá»ƒ thÃªm má»™t `Compose` Ä‘á»ƒ kiá»ƒm tra:

```plaintext
body('Parse_JSON')?['Files']
```

Xem trong run history Ä‘á»ƒ biáº¿t chÃ­nh xÃ¡c kiá»ƒu dá»¯ liá»‡u Ä‘ang vá» lÃ  gÃ¬ (null, [] hay cÃ³ máº£ng).

---

Náº¿u báº¡n muá»‘n, mÃ¬nh cÃ³ thá»ƒ giÃºp báº¡n táº¡o nhanh 1 Ä‘oáº¡n flow máº«u vá»›i cÃ¡c Ä‘iá»u kiá»‡n nÃ y. Báº¡n dÃ¹ng báº£n Cloud Flow Ä‘Ãºng khÃ´ng?
