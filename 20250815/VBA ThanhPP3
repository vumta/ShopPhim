INT((A1-WEEKDAY(A1;2)+7 - DATE(YEAR(A1-WEEKDAY(A1;2)+7-1); MONTH(A1-WEEKDAY(A1;2)+7-1); 1))/7) + 1

Sub CopyReportSalary_ByWeekName_Patched() Dim ws As Worksheet Dim lastRow As Long, lastCol As Long Dim weekHeaderRow As Long, reportHeaderRow As Long Dim targetWeek As String Dim weekColStart As Long Dim m As Variant Dim weekReportCol As Long, weekSalaryCol As Long Dim wbReport As Workbook, wsReport As Worksheet Dim savePath As String ' ====== THIẾT LẬP ====== Set ws = ThisWorkbook.Sheets(1) targetWeek = "Week 07.28 - 08.03 W1" weekHeaderRow = 2 ' bạn đặt = 2 reportHeaderRow = weekHeaderRow + 2 ' nếu Report/Salary nằm ở hàng 4 lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row lastCol = ws.Cells(weekHeaderRow, ws.Columns.Count).End(xlToLeft).Column ' ====== TÌM CỘT BẮT ĐẦU CỦA TUẦN ====== Dim c As Range weekColStart = 0 For Each c In ws.Range(ws.Cells(weekHeaderRow, 1), ws.Cells(weekHeaderRow, lastCol)) If Trim(c.Text) = targetWeek Then weekColStart = c.Column Exit For End If Next If weekColStart = 0 Then MsgBox "Không tìm thấy tiêu đề tuần: " & targetWeek, vbExclamation Exit Sub End If ' ====== TÌM CỘT REPORT ====== m = Application.Match("Report", ws.Range(ws.Cells(reportHeaderRow, weekColStart), ws.Cells(reportHeaderRow, lastCol)), 0) If IsError(m) Then MsgBox "Không thấy 'Report' ở hàng " & reportHeaderRow, vbExclamation Exit Sub End If weekReportCol = weekColStart + CLng(m) - 1 ' ====== TÌM CỘT SALARY ====== m = Application.Match("Salary", ws.Range(ws.Cells(reportHeaderRow, weekColStart), ws.Cells(reportHeaderRow, lastCol)), 0) If IsError(m) Then MsgBox "Không thấy 'Salary' ở hàng " & reportHeaderRow, vbExclamation Exit Sub End If weekSalaryCol = weekColStart + CLng(m) - 1 ' ====== GHI SANG REPORT.XLSX ====== savePath = ThisWorkbook.Path & "\Report.xlsx" Set wbReport = Workbooks.Open(savePath) Set wsReport = wbReport.Sheets(1) ' dữ liệu bắt đầu ngay dưới hàng header của "Report/Salary" Dim dataStart As Long, rowsToCopy As Long dataStart = reportHeaderRow + 1 rowsToCopy = ws.Cells(ws.Rows.Count, weekReportCol).End(xlUp).Row - dataStart + 1 If rowsToCopy < 1 Then rowsToCopy = 0 If rowsToCopy > 0 Then wsReport.Range("C5").Resize(rowsToCopy, 1).Value = ws.Range(ws.Cells(dataStart, weekReportCol), ws.Cells(dataStart + rowsToCopy - 1, weekReportCol)).Value wsReport.Range("D5").Resize(rowsToCopy, 1).Value = ws.Range(ws.Cells(dataStart, weekSalaryCol), ws.Cells(dataStart + rowsToCopy - 1, weekSalaryCol)).Value End If wsReport.Range("C4").Value = targetWeek & "_Report" wsReport.Range("D4").Value = targetWeek & "_Salary" wbReport.Save: wbReport.Close False MsgBox "Hoàn tất ghi dữ liệu cho " & targetWeek, vbInformation End Sub
