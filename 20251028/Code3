D∆∞·ªõi ƒë√¢y l√† m√£ VBA ho√†n ch·ªânh ƒë·ªÉ b·∫°n xu·∫•t ra file .bas, c√≥ th·ªÉ d√πng trong UiPath (Invoke VBA) ho·∫∑c ch·∫°y tr·ª±c ti·∫øp trong Excel.
File n√†y ch·ª©a function ch·∫°y m·ªôt Power Query (Get & Transform Data) trong workbook hi·ªán t·∫°i.


---

üîß N·ªôi dung file: RunPowerQuery.bas

Attribute VB_Name = "RunPowerQuery"
Option Explicit

'===========================================================
' M√î-ƒêUN: RunPowerQuery
' M√¥ t·∫£: G·ªçi refresh m·ªôt Power Query (Get & Transform) trong Excel
' C√≥ th·ªÉ ƒë∆∞·ª£c g·ªçi t·ª´ UiPath th√¥ng qua Invoke VBA
'===========================================================

'----------------------------------------
' H√†m ch√≠nh ƒë·ªÉ refresh query theo t√™n
'----------------------------------------
Public Sub RunQuery(QueryName As String)
    Dim wb As Workbook
    Dim qt As WorkbookQuery
    Dim ws As Worksheet
    Dim lo As ListObject
    Dim found As Boolean
    
    Set wb = ThisWorkbook
    found = False
    
    '=== Refresh query trong danh s√°ch Workbook Queries ===
    On Error Resume Next
    Set qt = wb.Queries(QueryName)
    On Error GoTo 0
    
    If Not qt Is Nothing Then
        Debug.Print "Refreshing query: " & QueryName
        qt.Refresh
        found = True
    End If
    
    '=== N·∫øu query g·∫Øn v√†o Table th√¨ refresh Table ƒë√≥ ===
    If Not found Then
        For Each ws In wb.Worksheets
            For Each lo In ws.ListObjects
                If lo.SourceType = xlSrcQuery Then
                    If LCase(lo.QueryTable.WorkbookConnection) Like "*" & LCase(QueryName) & "*" Then
                        Debug.Print "Refreshing table for query: " & QueryName
                        lo.QueryTable.Refresh BackgroundQuery:=False
                        found = True
                        Exit For
                    End If
                End If
            Next lo
            If found Then Exit For
        Next ws
    End If
    
    '=== B√°o l·ªói n·∫øu kh√¥ng t√¨m th·∫•y ===
    If Not found Then
        MsgBox "Kh√¥ng t√¨m th·∫•y query c√≥ t√™n: " & QueryName, vbExclamation, "RunPowerQuery"
    Else
        Debug.Print "Query '" & QueryName & "' refreshed successfully."
    End If
End Sub

'----------------------------------------
' H√†m ch·∫°y to√†n b·ªô query trong workbook
'----------------------------------------
Public Sub RunAllQueries()
    Dim wb As Workbook
    Dim qt As WorkbookQuery
    
    Set wb = ThisWorkbook
    For Each qt In wb.Queries
        Debug.Print "Refreshing query: " & qt.Name
        qt.Refresh
    Next qt
    Debug.Print "All queries refreshed successfully."
End Sub


---

üìò H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng

1. L∆∞u n·ªôi dung tr√™n v√†o file t√™n:
üëâ RunPowerQuery.bas


2. Import v√†o Excel VBA (Alt + F11 ‚Üí File ‚Üí Import File...).


3. Ho·∫∑c g·ªçi t·ª´ UiPath nh∆∞ sau:

D√πng activity Invoke VBA

File path: RunPowerQuery.bas

Entry method name:
RunQuery

Parameters:
{"T√™nQueryTrongExcel"}
(v√≠ d·ª•: {"SalesData"})





---

‚öôÔ∏è V√≠ d·ª• g·ªçi t·ª´ Excel tr·ª±c ti·∫øp

Sub TestRunQuery()
    RunQuery "SalesData"
End Sub

Sub TestRunAll()
    RunAllQueries
End Sub


---

B·∫°n c√≥ mu·ªën t√¥i t·∫°o lu√¥n file .bas s·∫µn ƒë·ªÉ t·∫£i v·ªÅ kh√¥ng (ƒë·ªÉ d√πng ngay trong UiPath)?
